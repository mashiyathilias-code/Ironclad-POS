<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronClad Loyalty v2.0 (Secure)</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --modal-bg: rgba(15, 23, 42, 0.95);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--light); height: 100vh; display: flex; overflow: hidden; color: var(--dark); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; background-color: var(--dark); color: white; display: flex; flex-direction: column;
            padding: 20px; box-shadow: var(--shadow); z-index: 10;
        }
        .brand { font-size: 1.4rem; font-weight: 800; margin-bottom: 40px; text-align: center; color: var(--warning); letter-spacing: 1px; }
        .nav-btn {
            background: none; border: none; color: #94a3b8; padding: 15px; text-align: left;
            cursor: pointer; font-size: 1rem; border-radius: 8px; margin-bottom: 8px;
            transition: all 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .nav-btn:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background-color: var(--secondary); color: white; font-weight: 600; }

        /* --- LAYOUTS --- */
        .main-content { flex: 1; position: relative; overflow: hidden; }
        .tab-content { display: none; height: 100%; padding: 30px; overflow-y: auto; }
        .tab-content.active { display: flex; gap: 20px; }
        .tab-col { display: flex; flex-direction: column; gap: 20px; }
        
        /* --- DIRECTORY TAB --- */
        .left-panel { flex: 1; }
        .right-panel { flex: 0 0 400px; }

        .panel-box { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); text-align: center; }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        
        .search-bar { width: 100%; padding: 15px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; }
        .member-list { overflow-y: auto; max-height: calc(100vh - 300px); }
        .member-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer;
        }
        .member-item:hover { background: #f1f5f9; }
        .member-item.active { background: #eff6ff; border-left: 4px solid var(--primary); }
        .m-avatar { width: 40px; height: 40px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #64748b; margin-right: 15px; }

        /* --- SETTINGS TAB --- */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; }
        .tier-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: var(--light); padding: 10px; border-radius: 8px; }
        
        /* --- VISUALS --- */
        .loyalty-card {
            height: 220px; width: 100%; border-radius: 16px; color: white;
            padding: 25px; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); position: relative; overflow: hidden;
            background: linear-gradient(135deg, #334155, #0f172a); /* Default */
            transition: background 0.5s ease;
        }
        .loyalty-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(rgba(255,255,255,0.1), rgba(255,255,255,0));
            transform: rotate(30deg); pointer-events: none;
        }
        .card-chip { width: 50px; height: 35px; background: rgba(255,255,255,0.2); border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); }
        .card-number { font-family: 'Courier New', monospace; font-size: 1.4rem; letter-spacing: 2px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        
        .btn-action { padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; width: 100%; margin-top: 10px;}
        .btn-earn { background: var(--success); }
        .btn-redeem { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-dark { background: var(--dark); }

        /* --- SECURITY OVERLAYS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        .login-card {
            background: white; padding: 40px; border-radius: 16px;
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-input { font-size: 2rem; text-align: center; letter-spacing: 8px; margin: 20px 0; width: 100%; padding: 10px; font-weight: bold; border: 2px solid var(--border); border-radius: 8px;}
        
        .hidden { display: none !important; }
        
        /* Tier Gradients */
        .bg-gradient-1 { background: linear-gradient(135deg, #78350f, #92400e); } /* Bronze */
        .bg-gradient-2 { background: linear-gradient(135deg, #475569, #94a3b8); } /* Silver */
        .bg-gradient-3 { background: linear-gradient(135deg, #b45309, #fbbf24); } /* Gold */
        .bg-gradient-4 { background: linear-gradient(135deg, #0f172a, #3b82f6); } /* Platinum */
        .bg-gradient-5 { background: linear-gradient(135deg, #000000, #444444); } /* Black */
    </style>
</head>
<body>

    <!-- SECURE BOOT LOADER & LOGIN -->
    <div id="loader" class="overlay">
        <div style="color:white; text-align:center;">
            <h2>IronClad Loyalty</h2>
            <p>Initializing Secure Vault...</p>
        </div>
    </div>

    <div id="auth-screen" class="overlay hidden">
        <div id="setup-view" class="login-card hidden">
            <div style="font-size: 3rem; margin-bottom: 10px;">‚öôÔ∏è</div>
            <h2>Encrypt Database</h2>
            <p style="color: #64748b; margin-bottom:20px;">Create a Master PIN to secure your customer data.</p>
            <input type="password" id="pin-setup" class="login-input" maxlength="8" placeholder="6-8 Digits" autofocus>
            <button class="btn-action btn-earn" onclick="app.setupSystem()">Initialize Vault</button>
        </div>

        <div id="login-view" class="login-card hidden">
            <div style="font-size: 3rem; margin-bottom: 10px;">üõ°Ô∏è</div>
            <h2>Locked</h2>
            <p style="color: #64748b; margin-bottom: 20px;">Enter PIN to Decrypt</p>
            <input type="password" id="pin-input" class="login-input" maxlength="8" placeholder="Enter PIN">
            <button class="btn-action btn-earn" onclick="app.login()">Unlock</button>
        </div>
    </div>

    <!-- APP INTERFACE -->
    <div class="sidebar">
        <div class="brand">üíé IronClad Loyalty</div>
        <button class="nav-btn active" onclick="app.switchTab('directory', this)">üë• Directory</button>
        <button class="nav-btn" onclick="app.switchTab('settings', this)">‚öôÔ∏è Settings</button>
        
        <div style="margin-top:auto; font-size:0.75rem; opacity:0.7; padding: 10px;">
            <p>Vault: <span style="color:var(--success)">Encrypted</span></p>
            <button class="btn-danger" style="margin-top:10px; width:100%; padding:8px;" onclick="location.reload()">üîí Lock Now</button>
        </div>
    </div>

    <div class="main-content">
        
        <!-- TAB: DIRECTORY -->
        <div id="directory" class="tab-content active">
            <div class="left-panel tab-col">
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="st-members">0</div>
                        <div>Total Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="st-points">0</div>
                        <div>Total Points</div>
                    </div>
                    <div class="stat-card" style="padding:10px; display:flex; align-items:center;">
                        <button class="btn-action btn-earn" style="height:100%; margin:0;" onclick="app.openModal('modal-new-member')">+ New Member</button>
                    </div>
                </div>

                <div class="panel-box" style="flex:1; display:flex; flex-direction:column;">
                    <input type="text" class="search-bar" placeholder="Search Name or Phone..." onkeyup="app.renderList(this.value)">
                    <div class="member-list" id="member-list"></div>
                </div>
            </div>

            <div class="right-panel tab-col">
                <div id="empty-state" class="panel-box" style="text-align:center; padding:50px 20px; color:#94a3b8;">
                    <div style="font-size:3rem; margin-bottom:10px;">üë§</div>
                    <p>Select a member to view details.</p>
                </div>

                <div id="profile-view" class="hidden tab-col" style="margin:0; padding:0;">
                    <!-- Card Visual -->
                    <div class="loyalty-card" id="card-visual">
                        <div style="position:absolute; top:20px; right:20px; font-weight:800; opacity:0.8;" id="card-tier-text">TIER</div>
                        <div class="card-chip"></div>
                        <div style="margin-top:auto;">
                            <div class="card-number" id="card-phone">000</div>
                            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:10px;">
                                <div style="font-weight:600; text-transform:uppercase;" id="card-name">NAME</div>
                                <div style="font-size:1.5rem; font-weight:bold;"><span id="card-points">0</span> PTS</div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="panel-box">
                        <h3>Actions</h3>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <button class="btn-action btn-earn" onclick="app.openTx('earn')">Add Points</button>
                            <button class="btn-action btn-redeem" onclick="app.openTx('redeem')">Redeem</button>
                        </div>
                        <button class="btn-action btn-dark" onclick="app.delMember()" style="margin-top:10px; font-size:0.8rem;">Delete Profile</button>
                    </div>

                    <!-- History -->
                    <div class="panel-box" style="flex:1;">
                        <h3>History</h3>
                        <div id="tx-history" style="margin-top:10px; font-size:0.9rem; max-height:200px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: SETTINGS -->
        <div id="settings" class="tab-content">
            <h2 style="margin-bottom:20px;">System Configuration</h2>
            <div class="settings-grid">
                
                <div class="tab-col">
                    <div class="panel-box">
                        <h3>Currency & Points</h3>
                        <p style="color:#64748b; font-size:0.9rem; margin-bottom:15px;">Define how much 1 point is worth in your currency.</p>
                        <label style="font-weight:bold;">1 Point = </label>
                        <input type="number" id="set-point-val" step="0.01" style="padding:5px; width:100px; border-radius:4px; border:1px solid #ccc;">
                        <span style="font-weight:bold;">Currency</span>
                        <button class="btn-action btn-dark" style="margin-top:10px; width:auto;" onclick="app.saveGlobalSettings()">Save Value</button>
                    </div>

                    <div class="panel-box">
                        <h3>Backup & Recovery</h3>
                        <p style="color:#64748b; font-size:0.9rem; margin-bottom:15px;">Exports are raw JSON (Keep safe!). Import overwrites current database.</p>
                        <button class="btn-action btn-redeem" onclick="app.exportData()">üì• Export Backup</button>
                        <button class="btn-action btn-dark" onclick="document.getElementById('file-import').click()">üì§ Import Backup</button>
                        <input type="file" id="file-import" class="hidden" onchange="app.importData(this)">
                    </div>
                </div>

                <div class="tab-col">
                    <div class="panel-box">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3>Custom Tiers</h3>
                            <button class="btn-action btn-earn" style="width:auto; padding:5px 10px; margin:0;" onclick="app.addTier()">+ Add Tier</button>
                        </div>
                        <div id="tier-list-container"></div>
                        <small style="color:#64748b;">Higher point requirement tiers override lower ones.</small>
                        <button class="btn-action btn-dark" onclick="app.saveTiers()">Save Tier Config</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- MODALS -->
    <div id="modal-new-member" class="overlay hidden">
        <div class="login-card" style="text-align:left;">
            <h3>New Member</h3>
            <label style="display:block; margin-top:10px;">Full Name</label>
            <input type="text" id="new-name" class="search-bar" style="margin:5px 0;">
            <label style="display:block; margin-top:10px;">Phone / ID</label>
            <input type="text" id="new-phone" class="search-bar" style="margin:5px 0;">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-action btn-earn" onclick="app.createMember()">Create</button>
                <button class="btn-action btn-danger" onclick="app.closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-tx" class="overlay hidden">
        <div class="login-card" style="text-align:left;">
            <h3 id="tx-title">Transaction</h3>
            <p id="tx-subtitle" style="color:#64748b; font-size:0.9rem; margin-bottom:10px;"></p>
            <label style="display:block; margin-top:10px;">Points</label>
            <input type="number" id="tx-points" class="search-bar" style="margin:5px 0;" onkeyup="app.calcVal()">
            <div id="val-preview" style="text-align:right; font-weight:bold; color:var(--success); margin-bottom:10px;">Value: $0.00</div>
            <label style="display:block;">Note</label>
            <input type="text" id="tx-note" class="search-bar" style="margin:5px 0;">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-action btn-earn" id="btn-confirm-tx">Confirm</button>
                <button class="btn-action btn-danger" onclick="app.closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        /** SECURITY ENGINE (AES-GCM + PBKDF2) **/
        class CryptoManager {
            constructor() { this.key = null; }
            async genKey(pin, salt) {
                const enc = new TextEncoder();
                const k = await window.crypto.subtle.importKey("raw", enc.encode(pin), {name:"PBKDF2"}, false, ["deriveKey"]);
                return await window.crypto.subtle.deriveKey(
                    {name:"PBKDF2", salt:salt, iterations:100000, hash:"SHA-256"},
                    k, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]
                );
            }
            async encrypt(data) {
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const enc = new TextEncoder().encode(JSON.stringify(data));
                const c = await window.crypto.subtle.encrypt({name:"AES-GCM", iv}, this.key, enc);
                return { iv: Array.from(iv), d: Array.from(new Uint8Array(c)) };
            }
            async decrypt(obj) {
                try {
                    const dec = await window.crypto.subtle.decrypt(
                        {name:"AES-GCM", iv:new Uint8Array(obj.iv)}, 
                        this.key, new Uint8Array(obj.d)
                    );
                    return JSON.parse(new TextDecoder().decode(dec));
                } catch(e) { return null; }
            }
        }

        /** DATABASE (IndexedDB) **/
        class DB {
            constructor() { this.db = null; }
            open() {
                return new Promise(r => {
                    const req = indexedDB.open('IRONCLAD_LOYALTY', 1);
                    req.onupgradeneeded = e => {
                        const d = e.target.result;
                        if(!d.objectStoreNames.contains('members')) d.createObjectStore('members', {keyPath:'id'});
                        if(!d.objectStoreNames.contains('config')) d.createObjectStore('config', {keyPath:'id'});
                    };
                    req.onsuccess = e => { this.db = e.target.result; r(); };
                });
            }
            async put(s, d) { return new Promise(r => { this.db.transaction(s,'readwrite').objectStore(s).put(d).onsuccess=()=>r(); }); }
            async get(s, k) { return new Promise(r => { const q=this.db.transaction(s,'readonly').objectStore(s).get(k); q.onsuccess=()=>r(q.result); }); }
            async getAll(s) { return new Promise(r => { const q=this.db.transaction(s,'readonly').objectStore(s).getAll(); q.onsuccess=()=>r(q.result); }); }
            async del(s, k) { return new Promise(r => { this.db.transaction(s,'readwrite').objectStore(s).delete(k).onsuccess=()=>r(); }); }
            async clear(s) { return new Promise(r => { this.db.transaction(s,'readwrite').objectStore(s).clear().onsuccess=()=>r(); }); }
        }

        /** APP LOGIC **/
        class App {
            constructor() {
                this.c = new CryptoManager();
                this.db = new DB();
                this.members = [];
                this.activeId = null;
                // Default Config
                this.config = {
                    pointVal: 0.05,
                    tiers: [
                        { min: 5000, name: 'Platinum', style: 'bg-gradient-4' },
                        { min: 2500, name: 'Gold', style: 'bg-gradient-3' },
                        { min: 1000, name: 'Silver', style: 'bg-gradient-2' },
                        { min: 0, name: 'Bronze', style: 'bg-gradient-1' }
                    ]
                };
            }

            async init() {
                await this.db.open();
                document.getElementById('loader').classList.add('hidden');
                
                // Check if system is initialized (Salt exists)
                const salt = localStorage.getItem('loyalty_salt');
                if(!salt) {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('setup-view').classList.remove('hidden');
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('login-view').classList.remove('hidden');
                }
            }

            /* --- SECURITY --- */
            async setupSystem() {
                const pin = document.getElementById('pin-setup').value;
                if(pin.length < 6) return alert("PIN too short");
                
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                localStorage.setItem('loyalty_salt', JSON.stringify(Array.from(salt)));
                
                this.c.key = await this.c.genKey(pin, salt);
                
                // Save Initial Config Encrypted
                await this.saveConfig();
                this.enter();
            }

            async login() {
                const pin = document.getElementById('pin-input').value;
                const salt = new Uint8Array(JSON.parse(localStorage.getItem('loyalty_salt')));
                this.c.key = await this.c.genKey(pin, salt);
                
                // Test Decryption
                const conf = await this.db.get('config', 'main');
                if(conf) {
                    const dec = await this.c.decrypt(conf.data);
                    if(!dec) return alert("Invalid PIN");
                    this.config = dec;
                } else {
                    await this.saveConfig(); // First run after setup
                }
                
                this.enter();
            }

            async enter() {
                document.getElementById('auth-screen').classList.add('hidden');
                await this.loadMembers();
                this.renderAll();
            }

            /* --- DATA OPS --- */
            async saveConfig() {
                const enc = await this.c.encrypt(this.config);
                await this.db.put('config', {id:'main', data:enc});
            }

            async loadMembers() {
                const raw = await this.db.getAll('members');
                this.members = [];
                for(let r of raw) {
                    const m = await this.c.decrypt(r.data);
                    if(m) this.members.push(m);
                }
                this.members.sort((a,b) => b.points - a.points);
            }

            async saveMember(m) {
                const enc = await this.c.encrypt(m);
                await this.db.put('members', {id:m.id, data:enc});
            }

            /* --- LOGIC --- */
            getTier(pts) {
                // Sort config tiers desc
                const sorted = [...this.config.tiers].sort((a,b) => b.min - a.min);
                return sorted.find(t => pts >= t.min) || sorted[sorted.length-1];
            }

            renderAll() {
                this.renderList();
                this.renderSettings();
                this.updateStats();
            }

            updateStats() {
                document.getElementById('st-members').innerText = this.members.length;
                document.getElementById('st-points').innerText = this.members.reduce((a,b)=>a+b.points,0).toLocaleString();
            }

            /* --- DIRECTORY --- */
            renderList(filter = '') {
                const list = document.getElementById('member-list');
                list.innerHTML = this.members
                    .filter(m => m.name.toLowerCase().includes(filter.toLowerCase()) || m.phone.includes(filter))
                    .map(m => {
                        const t = this.getTier(m.points);
                        return `
                        <div class="member-item ${this.activeId===m.id ? 'active' : ''}" onclick="app.select(${m.id})">
                            <div style="display:flex; align-items:center;">
                                <div class="m-avatar">${m.name.substring(0,2).toUpperCase()}</div>
                                <div><b>${m.name}</b><br><small>${m.phone}</small></div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:var(--primary); font-weight:bold;">${m.points}</div>
                                <div style="font-size:0.7rem;">${t.name}</div>
                            </div>
                        </div>`;
                    }).join('');
            }

            select(id) {
                this.activeId = id;
                this.renderList(document.querySelector('.search-bar').value);
                const m = this.members.find(x => x.id === id);
                if(!m) return;

                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('profile-view').classList.remove('hidden');
                
                const t = this.getTier(m.points);
                const card = document.getElementById('card-visual');
                
                // Reset classes then add specific gradient
                card.className = 'loyalty-card ' + t.style;
                
                document.getElementById('card-name').innerText = m.name;
                document.getElementById('card-phone').innerText = m.phone;
                document.getElementById('card-points').innerText = m.points.toLocaleString();
                document.getElementById('card-tier-text').innerText = t.name.toUpperCase();

                document.getElementById('tx-history').innerHTML = (m.history || []).slice().reverse().map(h => 
                    `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:5px 0;">
                        <span>${h.note} <small style="color:#999">(${new Date(h.date).toLocaleDateString()})</small></span>
                        <span style="color:${h.amt>0?'var(--success)':'var(--danger)'}">${h.amt>0?'+':''}${h.amt}</span>
                    </div>`
                ).join('');
            }

            async createMember() {
                const name = document.getElementById('new-name').value;
                const phone = document.getElementById('new-phone').value;
                if(!name || !phone) return;

                const m = { id: Date.now(), name, phone, points: 0, history: [] };
                this.members.push(m);
                await this.saveMember(m);
                this.closeModals();
                this.renderAll();
                this.select(m.id);
            }

            async delMember() {
                if(!confirm("Delete this member permanently?")) return;
                await this.db.del('members', this.activeId);
                this.activeId = null;
                await this.loadMembers();
                document.getElementById('profile-view').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                this.renderAll();
            }

            /* --- TRANSACTIONS --- */
            openTx(type) {
                if(!this.activeId) return;
                document.getElementById('modal-tx').classList.remove('hidden');
                const title = type === 'earn' ? 'Add Points' : 'Redeem Points';
                document.getElementById('tx-title').innerText = title;
                
                const btn = document.getElementById('btn-confirm-tx');
                btn.onclick = () => this.processTx(type);
                btn.className = `btn-action ${type==='earn'?'btn-earn':'btn-redeem'}`;
                
                // Subtitle for redemption
                if(type === 'redeem') {
                    const m = this.members.find(x => x.id === this.activeId);
                    const val = (m.points * this.config.pointVal).toFixed(2);
                    document.getElementById('tx-subtitle').innerText = `Available: ${m.points} pts ($${val})`;
                } else {
                    document.getElementById('tx-subtitle').innerText = "";
                }

                document.getElementById('tx-points').value = '';
                document.getElementById('tx-note').value = '';
                document.getElementById('val-preview').innerText = '';
            }

            calcVal() {
                const p = document.getElementById('tx-points').value;
                const v = (p * this.config.pointVal).toFixed(2);
                document.getElementById('val-preview').innerText = `Value: $${v}`;
            }

            async processTx(type) {
                const pts = parseInt(document.getElementById('tx-points').value);
                const note = document.getElementById('tx-note').value || (type==='earn'?'Manual Add':'Redemption');
                if(!pts || pts <= 0) return;

                const m = this.members.find(x => x.id === this.activeId);
                if(type === 'redeem' && m.points < pts) return alert("Insufficient Points");

                const delta = type === 'earn' ? pts : -pts;
                m.points += delta;
                m.history.push({ date: Date.now(), amt: delta, note });

                await this.saveMember(m);
                this.closeModals();
                this.renderAll();
                this.select(m.id);
            }

            /* --- SETTINGS --- */
            renderSettings() {
                document.getElementById('set-point-val').value = this.config.pointVal;
                
                // Render Tiers
                const con = document.getElementById('tier-list-container');
                con.innerHTML = this.config.tiers.sort((a,b)=>b.min-a.min).map((t, i) => `
                    <div class="tier-row">
                        <div style="width:20px; height:20px; border-radius:50%;" class="${t.style}"></div>
                        <input type="text" value="${t.name}" onchange="app.updateTier(${i}, 'name', this.value)" style="width:100px; padding:5px;">
                        <input type="number" value="${t.min}" onchange="app.updateTier(${i}, 'min', this.value)" style="width:80px; padding:5px;">
                        <select onchange="app.updateTier(${i}, 'style', this.value)" style="padding:5px;">
                            <option value="bg-gradient-1" ${t.style.includes('1')?'selected':''}>Bronze</option>
                            <option value="bg-gradient-2" ${t.style.includes('2')?'selected':''}>Silver</option>
                            <option value="bg-gradient-3" ${t.style.includes('3')?'selected':''}>Gold</option>
                            <option value="bg-gradient-4" ${t.style.includes('4')?'selected':''}>Platinum</option>
                            <option value="bg-gradient-5" ${t.style.includes('5')?'selected':''}>Black</option>
                        </select>
                        <button class="btn-danger" style="width:30px; padding:2px;" onclick="app.delTier(${i})">x</button>
                    </div>
                `).join('');
            }

            updateTier(idx, field, val) {
                const sorted = [...this.config.tiers].sort((a,b)=>b.min-a.min);
                sorted[idx][field] = field === 'min' ? parseInt(val) : val;
                this.config.tiers = sorted;
            }

            addTier() {
                this.config.tiers.push({name:'New Tier', min:0, style:'bg-gradient-1'});
                this.renderSettings();
            }

            delTier(idx) {
                const sorted = [...this.config.tiers].sort((a,b)=>b.min-a.min);
                sorted.splice(idx, 1);
                this.config.tiers = sorted;
                this.renderSettings();
            }

            async saveGlobalSettings() {
                this.config.pointVal = parseFloat(document.getElementById('set-point-val').value);
                await this.saveConfig();
                alert("Settings Saved");
            }

            async saveTiers() {
                await this.saveConfig();
                alert("Tiers Updated");
                this.renderAll();
                if(this.activeId) this.select(this.activeId); // Refresh visual
            }

            /* --- BACKUP --- */
            async exportData() {
                if(!confirm("Download Unencrypted JSON Backup?")) return;
                const data = { config: this.config, members: this.members, date: Date.now() };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `loyalty_backup_${Date.now()}.json`;
                a.click();
            }

            async importData(input) {
                if(!input.files[0]) return;
                if(!confirm("Warning: This will overwrite your current database. Continue?")) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const d = JSON.parse(e.target.result);
                        if(!d.members || !d.config) throw "Invalid Format";
                        
                        await this.db.clear('members');
                        this.config = d.config;
                        await this.saveConfig();

                        for(let m of d.members) {
                            await this.saveMember(m);
                        }
                        
                        alert("Import Successful. Reloading...");
                        location.reload();
                    } catch(err) {
                        alert("Import Failed: " + err);
                    }
                };
                reader.readAsText(input.files[0]);
            }

            /* --- UTIL --- */
            switchTab(id, btn) {
                document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
                btn.classList.add('active');
            }

            openModal(id) { document.getElementById(id).classList.remove('hidden'); }
            closeModals() { document.querySelectorAll('.overlay:not(#auth-screen)').forEach(x=>x.classList.add('hidden')); }
        }

        const app = new App();
        window.onload = () => app.init();
    </script>
</body>
</html>