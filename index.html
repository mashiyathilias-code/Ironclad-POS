<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronClad POS v2.3 - Loyalty Redemption</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --modal-bg: rgba(15, 23, 42, 0.95);
        }
        @media print {
    /* Hide everything except the receipt content */
    body * { visibility: hidden; }
    #receipt-modal, #receipt-modal *, .receipt-visual, .receipt-visual * {
        visibility: visible;
    }
    #receipt-modal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white !important;
    }
    .receipt-actions, .sidebar, .main-content {
        display: none !important;
    }
    .receipt-card {
        box-shadow: none !important;
        width: 100% !important;
        max-height: none !important;
    }
}

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--light); height: 100vh; display: flex; overflow: hidden; color: var(--dark); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; background-color: var(--dark); color: white; display: flex; flex-direction: column;
            padding: 20px; box-shadow: var(--shadow); z-index: 10;
        }
        .brand { font-size: 1.4rem; font-weight: 800; margin-bottom: 40px; text-align: center; color: var(--success); letter-spacing: 1px; }
        .nav-btn {
            background: none; border: none; color: #94a3b8; padding: 15px; text-align: left;
            cursor: pointer; font-size: 1rem; border-radius: 8px; margin-bottom: 8px;
            transition: all 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .nav-btn:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background-color: var(--primary); color: white; font-weight: 600; }
        .nav-btn.restricted { display: none; } 

        /* --- CONTENT --- */
        .main-content { flex: 1; padding: 25px; overflow-y: auto; position: relative; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; }
        
        h2 { margin-bottom: 20px; color: var(--dark); border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block; width: fit-content; }
        
        /* --- SALES LAYOUT --- */
        .sales-header { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
        .cat-pill {
            padding: 8px 16px; border-radius: 20px; background: white; border: 1px solid var(--border);
            cursor: pointer; white-space: nowrap; transition: all 0.2s; font-size: 0.9rem;
        }
        .cat-pill:hover { border-color: var(--primary); color: var(--primary); }
        .cat-pill.active { background: var(--primary); color: white; border-color: var(--primary); }

        .sales-container { display: flex; gap: 20px; height: 100%; overflow: hidden; }
        .product-grid { 
            flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; overflow-y: auto; align-content: start; padding-bottom: 20px;
        }
        
        .product-card {
            background: var(--white); border-radius: 12px; padding: 15px; box-shadow: var(--shadow);
            cursor: pointer; transition: transform 0.2s, border-color 0.2s; border: 2px solid transparent;
            display: flex; flex-direction: column; justify-content: space-between; height: 130px;
        }
        .product-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .product-card.out-of-stock { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .p-cat { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: bold; }
        
        /* --- CART --- */
        .cart-panel {
            flex: 1; background: var(--white); border-radius: 12px; padding: 20px;
            box-shadow: var(--shadow); display: flex; flex-direction: column; min-width: 340px;
        }
        .cart-items { flex: 1; overflow-y: auto; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border); }
        
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95rem; color: #64748b; align-items: center; }
        .total-row { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 2px solid var(--dark); font-size: 1.4rem; font-weight: 800; color: var(--dark); }
        
        .btn-checkout { background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 15px; }
        .btn-checkout:hover { filter: brightness(1.1); }

        .customer-input-group { background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .customer-input-group input { border: 1px solid #cbd5e1; margin-bottom: 8px; }
        
        /* LOYALTY GRID */
        .loyalty-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .loyalty-box { padding: 8px; border-radius: 6px; text-align: center; font-size: 0.85rem; font-weight: bold; }
        .l-earn { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .l-spend { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .l-label { display: block; font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; margin-bottom: 2px; }

        /* --- FORMS & TABLES --- */
        .panel-box { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .full-width { grid-column: span 2; }
        
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: white; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }
        .btn-danger { background: var(--danger); color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-void { background: #cbd5e1; color: #334155; padding: 5px 10px; border:none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        table { width: 100%; border-collapse: collapse; background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        th { background: var(--dark); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        tr.refunded td { text-decoration: line-through; color: #94a3b8; }

        /* --- OVERLAYS (LOGIN & MODALS) --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        
        .login-card {
            background: white; padding: 40px; border-radius: 16px;
            width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .login-input { font-size: 2rem; text-align: center; letter-spacing: 8px; margin: 20px 0; font-weight: bold; border: 2px solid var(--border); }
        .login-input:focus { border-color: var(--primary); outline: none; }
        
        .lockout-msg { color: var(--danger); font-weight: bold; margin-top: 10px; font-size: 0.9rem; }
        .setup-warning { font-size: 0.8rem; background: #fff7ed; color: #9a3412; padding: 10px; border-radius: 6px; margin: 15px 0; text-align: left; border: 1px solid #fed7aa; }

        .receipt-card {
            background: white; width: 400px; max-height: 90vh; overflow-y: auto;
            padding: 0; display: flex; flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
        }
        .receipt-visual {
            padding: 40px; font-family: 'Courier New', monospace; 
            background: #fff; color: #000; font-size: 1.2rem;
        }
        .receipt-actions {
            background: var(--light); padding: 15px; border-top: 1px solid var(--border);
            display: flex; gap: 10px;
        }
        
        .r-header { text-align: center; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        .r-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1.1rem; }
        .r-total-block { border-top: 2px dashed #000; margin-top: 15px; padding-top: 10px; font-weight: bold; text-align: right; }
        
        /* Z-Report Specifics */
        .z-table { width: 100%; margin-top: 15px; border-top: 1px solid #000; }
        .z-table td { border: none; padding: 5px 0; font-family: 'Courier New', monospace; }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000;
        }

        .hidden { display: none !important; }
        .badge-role { background: var(--warning); color: black; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loader">
        <h2 style="color:white; border:none;">IronClad POS v2.1</h2>
        <p>Initializing Crypto Engine & Storage...</p>
    </div>

    <div id="login-screen" class="overlay hidden">
        <div id="setup-view" class="login-card hidden">
            <div style="font-size: 3rem; margin-bottom: 10px;">‚öôÔ∏è</div>
            <h2>System Setup</h2>
            <div class="setup-warning">
                <b>‚ö†Ô∏è MASTER KEY CREATION</b><br>
                Setting Admin PIN. This creates the primary encryption key.
            </div>
            <p style="color: #64748b; font-size: 0.9rem;">Create Admin PIN</p>
            <input type="password" id="pin-setup" class="login-input" maxlength="12" placeholder="6-12 Chars" autofocus>
            <button class="btn-checkout" onclick="app.setupSystem()">Initialize Vault</button>
        </div>

        <div id="login-view" class="login-card hidden">
            <div style="font-size: 3rem; margin-bottom: 10px;">üõ°Ô∏è</div>
            <h2>Secure Vault</h2>
            <p style="color: #64748b; margin-bottom: 10px;">Enter Admin or Cashier PIN</p>
            <input type="password" id="pin-input" class="login-input" maxlength="12" placeholder="Enter PIN">
            <div id="lockout-timer" class="lockout-msg hidden"></div>
            <button id="btn-unlock" class="btn-checkout" onclick="app.attemptLogin()">Decrypt & Unlock</button>
        </div>
    </div>

    <div id="receipt-modal" class="overlay hidden">
        <div class="receipt-card">
            <div class="receipt-visual">
                <div class="r-header">
                    <h3>IRONCLAD POS</h3>
                    <p id="rm-status">Secure Transaction Record</p>
                    <p id="rm-date">Date: </p>
                    <p id="rm-id">TxID: </p>
                    <p id="rm-cust" style="font-weight:bold;">Customer: </p>
                    <p id="rm-pay" style="font-size:0.9rem; margin-top:5px;">Method: -</p>
                </div>
                <div id="rm-body"></div>
                <div class="r-total-block">
                    <div style="display:flex; justify-content:space-between;"><span>Subtotal:</span><span id="rm-sub"></span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Discount:</span><span id="rm-disc"></span></div>
                    <div style="display:flex; justify-content:space-between;"><span>VAT:</span><span id="rm-tax"></span></div>
                    <div style="display:flex; justify-content:space-between; font-size:1.2em; margin-top:5px;"><span>TOTAL:</span><span id="rm-tot"></span></div>
                    
                    <div style="margin-top:15px; border-top:1px dotted #000; padding-top:5px; font-size:0.85rem;">
                        <div style="display:flex; justify-content:space-between;"><span>Loyalty Earned:</span><span id="rm-pts">0</span></div>
                        <div style="display:flex; justify-content:space-between;"><span>Pay w/ Points Value:</span><span id="rm-pts-cost">0</span></div>
                    </div>
                </div>
            </div>
            <div class="receipt-actions">
                <button class="btn-checkout" onclick="app.closeReceipt()">Close</button>
            </div>
        </div>
    </div>

    <!-- Z-REPORT MODAL -->
    <div id="z-report-modal" class="overlay hidden">
        <div class="receipt-card">
            <div class="receipt-visual">
                <div class="r-header">
                    <h3>END OF DAY (Z-REPORT)</h3>
                    <p id="z-date">Date: </p>
                </div>
                <div id="z-body"></div>
            </div>
            <div class="receipt-actions">
                <button class="btn-checkout" onclick="document.getElementById('z-report-modal').classList.add('hidden')">Close</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand">üõ°Ô∏è IronClad POS</div>
        <button class="nav-btn active" onclick="app.switchTab('sales')">üõí Sales Terminal</button>
        <button class="nav-btn" onclick="app.switchTab('history')">üïí History & Void</button>
        <button class="nav-btn admin-only" onclick="app.switchTab('inventory')">üì¶ Inventory</button>
        <button class="nav-btn admin-only" onclick="app.switchTab('looks')">üé® Looks & Users</button>
        <button class="nav-btn admin-only" onclick="app.switchTab('financials')">üìà Financials</button>
        
        <div style="margin-top:auto; font-size:0.75rem; opacity:0.7; padding: 10px;">
            <p>User: <span id="user-role-badge" class="badge-role">...</span></p>
            <button class="btn-danger" style="margin-top:5px; width:100%" onclick="location.reload()">üîí Lock System</button>
        </div>
    </div>

    <div class="main-content">
        <div id="sales" class="tab-content active">
            <h2>Sales Terminal</h2>
            <div class="sales-header" id="cat-filters"></div>
            <div class="sales-container">
                <div class="product-grid" id="pos-grid"></div>
                <div class="cart-panel">
                    <h3>Current Order</h3>
                    
                    <!-- Customer Tagging & Loyalty Info -->
                    <div class="customer-input-group">
                        <input type="text" id="cust-contact" placeholder="Customer Phone or Email">
                        <div class="loyalty-grid">
                            <div class="loyalty-box l-earn">
                                <span class="l-label">Points to Earn</span>
                                +<span id="cart-points-earn">0</span>
                            </div>
                            <div class="loyalty-box l-spend">
                                <span class="l-label">Pay w/ Points (Needed)</span>
                                <span id="cart-points-cost">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="cart-items" id="cart-items"></div>
                    <div class="summary-row"><span>Subtotal</span><span id="cart-sub">$0.00</span></div>
                    <div class="summary-row"><span>Discount (%)</span><input type="number" id="cart-discount-input" value="0" min="0" max="100" style="width: 60px; padding: 2px; text-align: right;" onchange="app.renderCart()"></div>
                    <div class="summary-row"><span>VAT (<span id="disp-tax-rate">0</span>%)</span><span id="cart-tax">$0.00</span></div>
                    <div class="summary-row" style="margin-top: 10px;">
                        <span>Payment Method:</span>
                        <select id="cart-pay-method" style="width: 140px; padding: 5px;"></select>
                    </div>
                    <div class="total-row"><span>Total</span><span id="cart-total">$0.00</span></div>
                    <button class="btn-checkout" onclick="app.checkout()">Charge Customer</button>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <h2>Transaction History</h2>
            <p style="color:#64748b; margin-bottom:15px;">View recent sales or process voids/refunds.</p>
            <div class="panel-box">
                <table>
                    <thead><tr><th>ID</th><th>Customer</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="hist-table"></tbody>
                </table>
            </div>
        </div>

        <div id="inventory" class="tab-content">
            <h2>Inventory Management</h2>
            <div class="panel-box">
                <div class="form-grid">
                    <input type="text" id="inv-name" placeholder="Item Name" class="full-width">
                    <select id="inv-cat" class="full-width"><option value="">Select Category</option></select>
                    <input type="number" id="inv-price" placeholder="Sell Price" step="0.01">
                    <input type="number" id="inv-cost" placeholder="Unit Cost" step="0.01">
                    <input type="number" id="inv-stock" placeholder="Stock Qty">
                    <button class="btn-primary" onclick="app.addProduct()">Add Product</button>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table><thead><tr><th>Item</th><th>Category</th><th>Price</th><th>Stock</th><th>Action</th></tr></thead><tbody id="inv-table"></tbody></table>
            </div>
        </div>

        <div id="looks" class="tab-content">
            <h2>Management Console</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="panel-box">
                        <h3>Staff Access</h3>
                        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Set a PIN for Cashier Mode (Sales Only).</p>
                        <div style="display:flex; gap:10px;">
                            <input type="password" id="new-cashier-pin" placeholder="New Cashier PIN" maxlength="12">
                            <button class="btn-primary" onclick="app.setCashierPin()">Set PIN</button>
                        </div>
                    </div>
                    <div class="panel-box">
                        <h3>Categories</h3>
                        <div style="display:flex; gap:10px; margin-bottom:10px;"><input type="text" id="new-cat-name" placeholder="e.g., Drinks"><button class="btn-primary" onclick="app.addCategory()">Add</button></div>
                        <div id="cat-list"></div>
                    </div>
                </div>
                <div>
                    <div class="panel-box">
                        <h3>Payment Methods</h3>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="new-pay-method" placeholder="e.g., Bitcoin">
                            <button class="btn-primary" onclick="app.addPaymentMethod()">Add</button>
                        </div>
                        <div id="pay-method-list"></div>
                    </div>
                    <div class="panel-box">
                        <h3>Encrypted Backup</h3>
                        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Exports cleartext JSON.</p>
                        <button class="btn-primary" style="background:var(--warning); width:100%; color:black;" onclick="app.exportSystem()">Export Full Backup</button>
                        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                        <input type="file" onchange="app.importSystem(this)">
                    </div>
                    <div class="panel-box">
                        <h3>Tax & Loyalty Settings</h3>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                            <span style="width:140px">Global VAT (%):</span>
                            <input type="number" id="setting-vat" style="width:100px;" onchange="app.saveSettings()">
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="width:140px">Loyalty (Pts per $1):</span>
                            <input type="number" id="setting-loyalty" style="width:100px;" placeholder="e.g. 10" onchange="app.saveSettings()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="financials" class="tab-content">
            <h2>Financial Overview</h2>
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="stats-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:20px; flex:1;">
                    <div class="panel-box" style="text-align:center; margin:0;"><div style="font-size:0.8rem; color:#666;">Net Revenue</div><div style="font-size:1.5rem; font-weight:bold;" id="fin-rev">$0.00</div></div>
                    <div class="panel-box" style="text-align:center; margin:0;"><div style="font-size:0.8rem; color:#666;">Net Profit</div><div style="font-size:1.5rem; font-weight:bold; color:var(--success);" id="fin-prof">$0.00</div></div>
                    <div class="panel-box" style="text-align:center; margin:0;"><div style="font-size:0.8rem; color:#666;">Tax Collected</div><div style="font-size:1.5rem; font-weight:bold;" id="fin-tax">$0.00</div></div>
                </div>
                <button class="btn-primary" style="margin-left:20px; height: 100%;" onclick="app.generateZReport()">üìú End-of-Day<br>Z-Report</button>
            </div>
            <div class="panel-box">
                <h3>Financial Log</h3>
                <table><thead><tr><th>ID</th><th>Items</th><th>Total</th><th>Time</th></tr></thead><tbody id="fin-table"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        /** CRYPTO ENGINE (Key Wrapping V2) **/
        class CryptoManager {
            constructor() { 
                this.masterKey = null; // The actual key that encrypts data
                this.salt = null;
            }

            // Generate a random 256-bit Master Key
            async generateMasterKey() {
                return await window.crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
            }

            // Derive a Key-Encryption-Key (KEK) from a PIN
            async deriveKEK(pin, salt) {
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(pin), { name: "PBKDF2" }, false, ["deriveKey"]);
                return await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                    keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"] // false = KEK cannot be exported
                );
            }

            // Wrap the Master Key using the PIN-derived KEK
            async wrapKey(kek, masterKey) {
                const exportedKey = await window.crypto.subtle.exportKey("raw", masterKey);
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encryptedKey = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, kek, exportedKey);
                return { iv: Array.from(iv), data: Array.from(new Uint8Array(encryptedKey)) };
            }

            // Unwrap the Master Key
            async unwrapKey(kek, wrappedObject) {
                try {
                    const rawKey = await window.crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: new Uint8Array(wrappedObject.iv) }, 
                        kek, 
                        new Uint8Array(wrappedObject.data)
                    );
                    return await window.crypto.subtle.importKey("raw", rawKey, { name: "AES-GCM" }, true, ["encrypt", "decrypt"]);
                } catch(e) { return null; }
            }

            // Standard Data Encryption using Master Key
            async encrypt(d) { 
                if(!this.masterKey) throw "Locked";
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const c = await window.crypto.subtle.encrypt({name:'AES-GCM', iv}, this.masterKey, new TextEncoder().encode(JSON.stringify(d)));
                return {iv:Array.from(iv), d:Array.from(new Uint8Array(c))};
            }

            async decrypt(p) { 
                if(!this.masterKey) throw "Locked";
                try { return JSON.parse(new TextDecoder().decode(await window.crypto.subtle.decrypt({name:'AES-GCM', iv:new Uint8Array(p.iv)}, this.masterKey, new Uint8Array(p.d)))); } 
                catch(e){ return null; }
            }
        }

        /** DATABASE LAYER **/
        class DB {
            constructor() { this.db = null; }
            open() {
                return new Promise(r => {
                    const req = indexedDB.open('POS_SECURE_VAULT_V2', 1);
                    req.onupgradeneeded = e => {
                        const d = e.target.result;
                        ['products','transactions','categories'].forEach(s => { if(!d.objectStoreNames.contains(s)) d.createObjectStore(s, {keyPath:'id'}); });
                    };
                    req.onsuccess = e => { this.db = e.target.result; r(); };
                });
            }
            async op(s, m, d) { return new Promise(r => { const tx=this.db.transaction(s,'readwrite').objectStore(s)[m](d); tx.onsuccess=()=>r(tx.result); }); }
            async getAll(s) { return new Promise(r => { const req=this.db.transaction(s,'readonly').objectStore(s).getAll(); req.onsuccess=()=>r(req.result); }); }
        }

        /** APP LOGIC **/
        class App {
            constructor() {
                this.c = new CryptoManager(); 
                this.db = new DB();
                this.cart = []; this.products = []; this.cats = []; this.txs = [];
                this.vat = parseFloat(localStorage.getItem('pos_vat')||0);
                this.loyaltyRate = parseFloat(localStorage.getItem('pos_loyalty_rate')||0);
                this.activeCat = 'all';
                this.role = null;
                // Payment Methods
                this.payMethods = JSON.parse(localStorage.getItem('pos_pay_methods')) || ['Cash', 'Card'];
            }

            async init() {
                // STORAGE PERSISTENCE API
                if (navigator.storage && navigator.storage.persist) {
                    navigator.storage.persist().then(granted => {
                        if (granted) console.log("Storage persistence granted.");
                        else console.log("Storage persistence denied.");
                    });
                }

                await this.db.open();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');

                const storedSalt = localStorage.getItem('pos_salt');
                
                if (!storedSalt) {
                    document.getElementById('setup-view').classList.remove('hidden');
                    document.getElementById('pin-setup').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.setupSystem(); });
                } else {
                    this.checkLockout();
                    document.getElementById('login-view').classList.remove('hidden');
                    document.getElementById('pin-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.attemptLogin(); });
                }
            }

            // XSS SANITIZATION
            sanitize(str) {
                if(!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            /* --- SECURITY & LOGIN LOGIC --- */

            async setupSystem() {
                const pin = document.getElementById('pin-setup').value;
                if(pin.length < 6) return alert("PIN must be at least 6 digits");
                if(!confirm("Warning: Losing this PIN means losing your data.")) return;

                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                this.c.salt = salt;

                // 1. Generate Master Key
                this.c.masterKey = await this.c.generateMasterKey();

                // 2. Derive Admin KEK and Wrap Master Key
                const adminKek = await this.c.deriveKEK(pin, salt);
                const wrappedKey = await this.c.wrapKey(adminKek, this.c.masterKey);

                localStorage.setItem('pos_salt', JSON.stringify(Array.from(salt)));
                localStorage.setItem('pos_wrapped_admin', JSON.stringify(wrappedKey));

                this.role = 'admin';
                this.enterApp();
            }

            async attemptLogin() {
                if(this.isLockedOut()) return;

                const pin = document.getElementById('pin-input').value;
                const salt = new Uint8Array(JSON.parse(localStorage.getItem('pos_salt')));
                
                // Try to Unlock as Admin
                const inputKek = await this.c.deriveKEK(pin, salt);
                const adminWrapped = JSON.parse(localStorage.getItem('pos_wrapped_admin'));
                
                let masterKey = await this.c.unwrapKey(inputKek, adminWrapped);
                
                if(masterKey) {
                    this.role = 'admin';
                    this.c.masterKey = masterKey;
                    localStorage.setItem('pos_fails', 0);
                    return this.enterApp();
                }

                // If not admin, try Cashier
                const cashierWrapped = JSON.parse(localStorage.getItem('pos_wrapped_cashier'));
                if(cashierWrapped) {
                    masterKey = await this.c.unwrapKey(inputKek, cashierWrapped);
                    if(masterKey) {
                        this.role = 'cashier';
                        this.c.masterKey = masterKey;
                        localStorage.setItem('pos_fails', 0);
                        return this.enterApp();
                    }
                }

                this.handleFail();
            }

            async setCashierPin() {
                const pin = document.getElementById('new-cashier-pin').value;
                if(!pin || pin.length < 4) return alert("PIN too short");
                
                // Wrap current MasterKey with new Cashier PIN
                const salt = new Uint8Array(JSON.parse(localStorage.getItem('pos_salt')));
                const cashierKek = await this.c.deriveKEK(pin, salt);
                const wrapped = await this.c.wrapKey(cashierKek, this.c.masterKey);
                
                localStorage.setItem('pos_wrapped_cashier', JSON.stringify(wrapped));
                alert("Cashier PIN Set Successfully");
                document.getElementById('new-cashier-pin').value = '';
            }

            handleFail() {
                let fails = parseInt(localStorage.getItem('pos_fails') || 0) + 1;
                localStorage.setItem('pos_fails', fails);
                document.getElementById('pin-input').value = '';
                
                if (fails >= 3) {
                    localStorage.setItem('pos_lockout', Date.now() + 30000); // 30s lockout
                    this.checkLockout();
                } else {
                    alert(`Incorrect PIN. Attempt ${fails}`);
                }
            }

            isLockedOut() { return Date.now() < parseInt(localStorage.getItem('pos_lockout') || 0); }

            checkLockout() {
                const lockUntil = parseInt(localStorage.getItem('pos_lockout') || 0);
                const now = Date.now();
                const timerEl = document.getElementById('lockout-timer');
                const btn = document.getElementById('btn-unlock');

                if (now < lockUntil) {
                    timerEl.innerText = `System Locked: ${Math.ceil((lockUntil - now) / 1000)}s`;
                    timerEl.classList.remove('hidden');
                    btn.disabled = true;
                    setTimeout(() => this.checkLockout(), 1000);
                } else {
                    timerEl.classList.add('hidden');
                    btn.disabled = false;
                }
            }

            async enterApp() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('user-role-badge').innerText = this.role.toUpperCase();
                
                // UI Restriction
                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(el => el.style.display = this.role === 'admin' ? 'flex' : 'none');

                await this.load();
                document.getElementById('setting-vat').value = this.vat;
                document.getElementById('setting-loyalty').value = this.loyaltyRate;
                this.renderAll();
            }

            /* --- CORE APP --- */

            async load() {
                const dec = async (arr) => {
                    const res = [];
                    for(let i of arr) {
                        const d = await this.c.decrypt(i.blob);
                        if(d) res.push({...d, id:i.id});
                    }
                    return res;
                };
                
                this.products = await dec(await this.db.getAll('products'));
                this.cats = await dec(await this.db.getAll('categories'));
                this.txs = await dec(await this.db.getAll('transactions'));
                this.txs.sort((a,b)=>b.date-a.date);
            }

            renderAll() {
                this.renderCats(); this.renderGrid(); this.renderInv(); this.renderFin(); this.renderHistory(); this.renderPayMethods();
                document.getElementById('disp-tax-rate').innerText = this.vat;
            }

            renderCats() {
                const html = `<div class="cat-pill ${this.activeCat==='all'?'active':''}" onclick="app.setCat('all')">All Items</div>` +
                    this.cats.map(c => `<div class="cat-pill ${this.activeCat===c.id?'active':''}" onclick="app.setCat(${c.id})">${this.sanitize(c.name)}</div>`).join('');
                document.getElementById('cat-filters').innerHTML = html;
                document.getElementById('cat-list').innerHTML = this.cats.map(c => 
                    `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${this.sanitize(c.name)}</span><button class="btn-danger" onclick="app.delCat(${c.id})">√ó</button></div>`
                ).join('');
                document.getElementById('inv-cat').innerHTML = '<option value="">Uncategorized</option>' + this.cats.map(c => `<option value="${c.id}">${this.sanitize(c.name)}</option>`).join('');
            }

            setCat(id) { this.activeCat = id; this.renderGrid(); this.renderCats(); }

            renderGrid() {
                const grid = document.getElementById('pos-grid');
                const filtered = this.activeCat === 'all' ? this.products : this.products.filter(p => p.catId == this.activeCat);
                grid.innerHTML = filtered.map(p => `
                    <div class="product-card ${p.stock<1?'out-of-stock':''}" onclick="app.addToCart(${p.id})">
                        <div><div class="p-name">${this.sanitize(p.name)}</div><div class="p-cat">${this.sanitize(this.cats.find(c=>c.id == p.catId)?.name || '')}</div></div>
                        <div><div class="p-price">$${p.price.toFixed(2)}</div><div class="p-stock">Stock: ${p.stock}</div></div>
                    </div>`).join('');
            }

            addToCart(id) {
                const p = this.products.find(x=>x.id===id);
                if(!p || p.stock<=0) return;
                const i = this.cart.find(x=>x.id===id);
                if(i) { if(i.qty < p.stock) i.qty++; } else this.cart.push({...p, qty:1});
                this.renderCart();
            }

            renderCart() {
                const con = document.getElementById('cart-items');
                let sub = 0;
                con.innerHTML = this.cart.map(i => {
                    sub += i.price * i.qty;
                    return `<div class="cart-item">
                        <div><b>${this.sanitize(i.name)}</b><br><small>$${i.price} x ${i.qty}</small></div>
                        <div><button onclick="app.mod(${i.id},-1)">-</button> ${i.qty} <button onclick="app.mod(${i.id},1)">+</button></div>
                    </div>`;
                }).join('');

                const discPct = parseFloat(document.getElementById('cart-discount-input').value) || 0;
                const discAmt = sub * (discPct/100);
                const afterDisc = sub - discAmt;
                const tax = afterDisc * (this.vat/100);
                const total = afterDisc + tax;

                // Loyalty Calculation
                // 1. Earning: Based on Post-Discount, Pre-Tax amount
                const pointsEarned = Math.floor(afterDisc * this.loyaltyRate);
                
                // 2. Redemption Cost: Based on Total (Inc Tax) / 0.01
                // 1 Point = $0.01 (Redemption Rate)
                const pointsNeeded = Math.ceil(total / 0.01);

                document.getElementById('cart-sub').innerText = `$${sub.toFixed(2)}`;
                document.getElementById('cart-tax').innerText = `$${tax.toFixed(2)}`;
                document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;
                
                // Loyalty Display
                document.getElementById('cart-points-earn').innerText = `${pointsEarned}`;
                document.getElementById('cart-points-cost').innerText = `${pointsNeeded} pts`;
            }

            mod(id, d) {
                const i = this.cart.find(x=>x.id===id);
                const p = this.products.find(x=>x.id===id);
                const n = i.qty + d;
                if(n<=0) this.cart = this.cart.filter(x=>x.id!==id);
                else if(n<=p.stock) i.qty = n;
                this.renderCart();
            }

            renderPayMethods() {
                // Cart Selection
                const cartSel = document.getElementById('cart-pay-method');
                cartSel.innerHTML = this.payMethods.map(m => `<option value="${m}">${this.sanitize(m)}</option>`).join('');
                
                // Admin List
                const adminList = document.getElementById('pay-method-list');
                adminList.innerHTML = this.payMethods.map(m => 
                    `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${this.sanitize(m)}</span><button class="btn-danger" onclick="app.delPaymentMethod('${m}')">√ó</button></div>`
                ).join('');
            }

            addPaymentMethod() {
                const val = document.getElementById('new-pay-method').value.trim();
                if(val && !this.payMethods.includes(val)) {
                    this.payMethods.push(val);
                    localStorage.setItem('pos_pay_methods', JSON.stringify(this.payMethods));
                    this.renderPayMethods();
                    document.getElementById('new-pay-method').value = '';
                }
            }

            delPaymentMethod(name) {
                if(!confirm(`Delete method ${name}?`)) return;
                this.payMethods = this.payMethods.filter(m => m !== name);
                localStorage.setItem('pos_pay_methods', JSON.stringify(this.payMethods));
                this.renderPayMethods();
            }

            async checkout() {
                if(!this.cart.length) return alert("Empty Cart");
                
                let sub=0, cost=0;
                this.cart.forEach(i => { sub += i.price*i.qty; cost += i.cost*i.qty; });
                const discPct = parseFloat(document.getElementById('cart-discount-input').value) || 0;
                const discAmt = sub * (discPct/100);
                const afterDisc = sub - discAmt;
                const tax = afterDisc * (this.vat/100);
                const total = afterDisc + tax;
                const payMethod = document.getElementById('cart-pay-method').value || 'Cash';
                
                const cust = document.getElementById('cust-contact').value.trim();
                
                // Loyalty Snapshot
                const pointsEarned = Math.floor(afterDisc * this.loyaltyRate);
                const pointsCost = Math.ceil(total / 0.01);

                // Inventory Deduction
                for(let i of this.cart) {
                    const p = this.products.find(x=>x.id===i.id);
                    p.stock -= i.qty;
                    await this.db.op('products', 'put', {id:p.id, blob:await this.c.encrypt(p)});
                }

                const tx = {
                    id: Date.now(), date: Date.now(), 
                    items: this.cart.map(x=>({id:x.id, n:x.name, q:x.qty, p:x.price})),
                    sub, disc: discAmt, tax, total, profit: (sub-discAmt)-cost,
                    method: payMethod,
                    customer: cust,
                    points: pointsEarned,
                    pointsCost: pointsCost, // Store how much it would cost in points for reference
                    refunded: false
                };
                
                await this.db.op('transactions', 'add', {id:tx.id, blob:await this.c.encrypt(tx)});
                this.showReceiptModal(tx);
            }

            showReceiptModal(tx) {
                document.getElementById('rm-status').innerText = tx.refunded ? "VOID / REFUNDED" : "Secure Transaction Record";
                document.getElementById('rm-status').style.color = tx.refunded ? "red" : "black";
                document.getElementById('rm-date').innerText = `Date: ${new Date(tx.date).toLocaleString()}`;
                document.getElementById('rm-id').innerText = `TxID: #${tx.id.toString().slice(-6)}`;
                document.getElementById('rm-cust').innerText = `Customer: ${this.sanitize(tx.customer || 'Guest')}`;
                document.getElementById('rm-pay').innerText = `Method: ${this.sanitize(tx.method || 'Cash')}`;
                document.getElementById('rm-body').innerHTML = tx.items.map(i => 
                    `<div class="r-item"><span>${i.q}x ${this.sanitize(i.n)}</span><span>${(i.p*i.q).toFixed(2)}</span></div>`
                ).join('');
                document.getElementById('rm-sub').innerText = tx.sub.toFixed(2);
                document.getElementById('rm-disc').innerText = `-${tx.disc.toFixed(2)}`;
                document.getElementById('rm-tax').innerText = tx.tax.toFixed(2);
                document.getElementById('rm-tot').innerText = `$${tx.total.toFixed(2)}`;
                
                document.getElementById('rm-pts').innerText = `${tx.points || 0} pts`;
                document.getElementById('rm-pts-cost').innerText = `${tx.pointsCost || 0} pts`;
                
                document.getElementById('receipt-modal').classList.remove('hidden');
            }

            async closeReceipt() {
                this.cart = []; 
                document.getElementById('cart-discount-input').value = 0;
                document.getElementById('cust-contact').value = '';
                document.getElementById('receipt-modal').classList.add('hidden');
                await this.load(); 
                this.renderAll(); 
            }

            /* --- HISTORY & REFUNDS --- */
            renderHistory() {
                document.getElementById('hist-table').innerHTML = this.txs.slice(0, 50).map(x => `
                    <tr class="${x.refunded ? 'refunded' : ''}">
                        <td>#${x.id.toString().slice(-4)}</td>
                        <td>${this.sanitize(x.customer || 'Guest')}</td>
                        <td>$${x.total.toFixed(2)}</td>
                        <td style="font-weight:bold; color:${x.refunded?'red':'green'}">${x.refunded ? 'VOID' : 'OK'}</td>
                        <td>
                            <button class="btn-primary" style="padding:4px 8px; font-size:0.8rem;" onclick='app.showReceiptModal(${JSON.stringify(x).replace(/'/g, "&apos;")})'>View</button>
                            ${!x.refunded ? `<button class="btn-void" onclick="app.refundTx(${x.id})">Void</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            }

            async refundTx(id) {
                if(!confirm("VOID Transaction? This will restore stock and balance financials.")) return;
                
                const tx = this.txs.find(x => x.id === id);
                if(!tx || tx.refunded) return;

                // 1. Mark Original as Refunded
                tx.refunded = true;
                await this.db.op('transactions', 'put', {id:tx.id, blob:await this.c.encrypt(tx)});

                // 2. Restore Stock
                for(let item of tx.items) {
                    const p = this.products.find(x => x.id === item.id);
                    if(p) {
                        p.stock += item.q;
                        await this.db.op('products', 'put', {id:p.id, blob:await this.c.encrypt(p)});
                    }
                }

                // 3. Create Negative Transaction for Balancing
                const refTx = {
                    id: Date.now(),
                    date: Date.now(),
                    items: tx.items.map(i=>({...i, n: `[REFUND] ${i.n}`, q: -i.q})),
                    sub: -tx.sub, disc: -tx.disc, tax: -tx.tax, total: -tx.total, profit: -tx.profit,
                    method: tx.method,
                    customer: tx.customer,
                    points: -(tx.points || 0), // Deduct Points on refund
                    refunded: true 
                };
                await this.db.op('transactions', 'add', {id:refTx.id, blob:await this.c.encrypt(refTx)});

                await this.load();
                this.renderAll();
                alert("Transaction Voided & Stock Restored");
            }

            /* --- ADMIN MANAGEMENT --- */
            async addCategory() {
                const n = document.getElementById('new-cat-name').value;
                if(!n) return;
                const c = {id:Date.now(), name:n};
                await this.db.op('categories', 'add', {id:c.id, blob:await this.c.encrypt(c)});
                document.getElementById('new-cat-name').value='';
                await this.load(); this.renderAll();
            }

            async delCat(id) {
                if(!confirm('Delete Category?')) return;
                await this.db.op('categories', 'delete', id);
                await this.load(); this.renderAll();
            }

            async addProduct() {
                const name = document.getElementById('inv-name').value;
                const catId = document.getElementById('inv-cat').value;
                const price = parseFloat(document.getElementById('inv-price').value);
                const cost = parseFloat(document.getElementById('inv-cost').value);
                const stock = parseInt(document.getElementById('inv-stock').value);
                if(!name || isNaN(price)) return;
                const p = { id:Date.now(), name, catId: catId?parseInt(catId):null, price, cost, stock };
                await this.db.op('products', 'add', {id:p.id, blob:await this.c.encrypt(p)});
                document.querySelectorAll('#inventory input').forEach(i=>i.value='');
                await this.load(); this.renderAll();
            }

            renderInv() {
                document.getElementById('inv-table').innerHTML = this.products.map(p => `
                    <tr><td>${this.sanitize(p.name)}</td><td>${this.sanitize(this.cats.find(c=>c.id==p.catId)?.name||'-')}</td>
                    <td>${p.price}</td><td>${p.stock}</td>
                    <td><button class="btn-danger" onclick="app.delProd(${p.id})">Del</button></td></tr>`
                ).join('');
            }
            async delProd(id) { if(confirm('Delete?')) { await this.db.op('products','delete',id); await this.load(); this.renderAll(); } }

            saveSettings() {
                this.vat = parseFloat(document.getElementById('setting-vat').value);
                this.loyaltyRate = parseFloat(document.getElementById('setting-loyalty').value);
                localStorage.setItem('pos_vat', this.vat);
                localStorage.setItem('pos_loyalty_rate', this.loyaltyRate);
                this.renderAll();
            }

            renderFin() {
                let r=0, p=0, t=0;
                this.txs.forEach(x => { 
                    r += x.total; 
                    p += x.profit; 
                    t += x.tax; 
                });
                document.getElementById('fin-rev').innerText = `$${r.toFixed(2)}`;
                document.getElementById('fin-prof').innerText = `$${p.toFixed(2)}`;
                document.getElementById('fin-tax').innerText = `$${t.toFixed(2)}`;
                document.getElementById('fin-table').innerHTML = this.txs.slice(0,20).map(x=>
                    `<tr><td>#${x.id.toString().slice(-4)}</td>
                    <td style="font-size:0.8rem">${x.items.length} items</td>
                    <td style="color:${x.total<0?'red':'black'}">$${x.total.toFixed(2)}</td><td>${new Date(x.date).toLocaleTimeString()}</td></tr>`
                ).join('');
            }

            // Z-REPORT GENERATION
            generateZReport() {
                const todayStart = new Date();
                todayStart.setHours(0,0,0,0);
                
                const todayTxs = this.txs.filter(t => t.date >= todayStart.getTime());
                
                let totalSales = 0;
                let totalTax = 0;
                let refundTotal = 0;
                let methodBreakdown = {};

                todayTxs.forEach(t => {
                    // Skip negative balancing transactions from stats to avoid double counting if needed,
                    // but for Z-report we want net.
                    // Actually, if we include negative transactions, the sum is correct net.
                    totalSales += t.total;
                    totalTax += t.tax;
                    
                    if(t.refunded) {
                        // Original transaction marked as refunded. 
                        // Do nothing here, as we likely have a negative counterpart transaction that balances it.
                        // However, purely for display:
                    }

                    // For Payment breakdown, we want to sum by method.
                    // Even negative refunds should have a method attached to reduce that method's total.
                    const method = t.method || 'Cash';
                    if(!methodBreakdown[method]) methodBreakdown[method] = 0;
                    methodBreakdown[method] += t.total;
                });

                const dateStr = todayStart.toLocaleDateString();
                document.getElementById('z-date').innerText = `Date: ${dateStr}`;
                
                let breakdownHtml = Object.keys(methodBreakdown).map(k => 
                    `<tr><td>${this.sanitize(k)}:</td><td style="text-align:right">$${methodBreakdown[k].toFixed(2)}</td></tr>`
                ).join('');

                const body = `
                    <table class="z-table">
                        <tr><td>Tx Count:</td><td style="text-align:right">${todayTxs.length}</td></tr>
                        <tr><td>Tax Collected:</td><td style="text-align:right">$${totalTax.toFixed(2)}</td></tr>
                        <tr style="font-weight:bold; font-size:1.1em; border-top:1px dashed #000;">
                            <td>NET SALES:</td><td style="text-align:right">$${totalSales.toFixed(2)}</td>
                        </tr>
                    </table>
                    <div style="margin-top:15px; font-weight:bold; border-bottom:1px solid #000;">By Payment Method:</div>
                    <table class="z-table">${breakdownHtml}</table>
                `;
                
                document.getElementById('z-body').innerHTML = body;
                document.getElementById('z-report-modal').classList.remove('hidden');
            }

            async exportSystem() {
                if(!confirm("Export Backup?")) return;
                const data = { vat: this.vat, loyalty: this.loyaltyRate, p: this.products, c: this.cats, t: this.txs };
                const b = new Blob([JSON.stringify(data)],{type:'application/json'});
                const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='pos_backup.json'; a.click();
            }

            async importSystem(inp) {
                if(!inp.files[0] || !confirm("OVERWRITE DATA?")) return;
                const r = new FileReader();
                r.onload = async e => {
                    try {
                        const d = JSON.parse(e.target.result);
                        localStorage.setItem('pos_vat', d.vat);
                        localStorage.setItem('pos_loyalty_rate', d.loyalty || 0);
                        const store = async (n, arr) => {
                            const tx = this.db.db.transaction(n,'readwrite').objectStore(n);
                            tx.clear(); 
                            for(let i of arr) {
                                const blob = await this.c.encrypt(i);
                                tx.put({id:i.id, blob:blob});
                            }
                            return new Promise(res => tx.transaction.oncomplete=res);
                        };
                        await store('products', d.p); await store('categories', d.c); await store('transactions', d.t);
                        location.reload();
                    } catch(err) { alert("Import Failed"); }
                };
                r.readAsText(inp.files[0]);
            }

            switchTab(id) {
                document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                event.currentTarget.classList.add('active');
            }
        }

        const app = new App();
        window.onload = () => app.init();
    </script>
</body>
</html>
