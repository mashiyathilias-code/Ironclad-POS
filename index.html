<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronClad POS V3.0</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            
            --primary: #38bdf8; /* Electric Cyan */
            --primary-glow: rgba(56, 189, 248, 0.4);
            --secondary: #818cf8;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --bg-deep: #0f172a;
        }

        /* --- AMBIENT BACKGROUND --- */
        body {
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, sans-serif;
            position: relative;
        }

        /* Floating Orbs for Glass Refraction */
        body::before {
            content: '';
            position: absolute;
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(56,189,248,0.15) 0%, rgba(0,0,0,0) 70%);
            top: -100px; left: -100px;
            z-index: 0;
            pointer-events: none;
        }
        body::after {
            content: '';
            position: absolute;
            width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(129,140,248,0.1) 0%, rgba(0,0,0,0) 70%);
            bottom: -100px; right: -100px;
            z-index: 0;
            pointer-events: none;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* --- GLASS MIXINS & UTILS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
            padding: 25px;
            z-index: 10;
            position: relative;
        }

        .brand {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 50px;
            text-align: center;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
            letter-spacing: 1px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 16px;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; gap: 12px;
            border: 1px solid transparent;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
            transform: translateX(5px);
            border-color: rgba(255,255,255,0.1);
        }

        .nav-btn.active {
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.15), transparent);
            color: var(--primary);
            font-weight: 600;
            border-left: 3px solid var(--primary);
            box-shadow: 0 4px 20px -5px var(--primary-glow);
        }
        .nav-btn.restricted { display: none; }

        /* --- CONTENT AREA --- */
        .main-content { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
            position: relative; 
            z-index: 5;
        }
        
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; }

        h2 {
            margin-bottom: 25px;
            color: #fff;
            font-weight: 300;
            font-size: 1.8rem;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 15px;
            display: inline-block;
            width: 100%;
        }

        /* --- SEARCH BAR --- */
        .search-wrapper {
            margin-bottom: 25px;
            position: relative;
        }

        #product-search {
            width: 100%;
            padding: 18px 20px 18px 55px;
            font-size: 1.1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            color: white;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
        }

        #product-search:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow), inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .search-icon {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            font-size: 1.2rem; color: var(--text-muted); pointer-events: none;
        }

        /* --- SALES HEADER & FILTERS --- */
        .sales-header { 
            display: flex; gap: 12px; overflow-x: auto; 
            padding-bottom: 15px; margin-bottom: 15px; 
            border-bottom: 1px solid var(--glass-border);
        }
        
        .cat-pill {
            padding: 10px 20px;
            border-radius: 30px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-size: 0.9rem;
            color: var(--text-muted);
            backdrop-filter: blur(5px);
        }
        
        .cat-pill:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
            transform: translateY(-2px);
        }
        
        .cat-pill.active {
            background: var(--primary);
            color: #000;
            font-weight: bold;
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        /* --- PRODUCT GRID --- */
        .sales-container { display: flex; gap: 25px; height: 100%; overflow: hidden; }
        
        .product-grid { 
            flex: 2; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 20px; 
            overflow-y: auto; 
            align-content: start; 
            padding-right: 10px;
            padding-bottom: 100px; /* Space for scroll */
        }
        
        .product-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-top: 1px solid rgba(255,255,255,0.2); /* Highlight top edge */
            border-radius: 16px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; justify-content: space-between;
            height: 140px;
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: 0.5s;
        }

        .product-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border-color: var(--primary);
        }
        
        .product-card:hover::before { left: 100%; }
        .product-card:active { transform: scale(0.98); }
        .product-card.out-of-stock { opacity: 0.4; pointer-events: none; filter: grayscale(1); }

        .p-name { font-weight: 600; font-size: 1rem; color: #fff; margin-bottom: 4px; line-height: 1.2;}
        .p-cat { font-size: 0.75rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .p-price { font-size: 1.2rem; font-weight: bold; color: var(--success); text-align: right; text-shadow: 0 0 10px rgba(52, 211, 153, 0.2); }
        .p-stock { font-size: 0.8rem; color: var(--text-muted); text-align: right; }

        /* --- CART PANEL (Glass Island) --- */
        .cart-panel {
            flex: 1; 
            min-width: 360px;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--glass-shadow);
            display: flex; flex-direction: column;
        }
        
        .cart-panel h3 { margin-bottom: 15px; color: white; letter-spacing: 1px; }

        .cart-items { 
            flex: 1; overflow-y: auto; 
            border-bottom: 1px solid var(--glass-border); 
            margin-bottom: 15px; 
            padding-right: 5px;
        }
        
        .cart-item {
            background: rgba(255,255,255,0.03);
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid transparent;
        }
        .cart-item:hover { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.06); }
        
        .cart-item b { color: #fff; }
        .cart-item small { color: var(--text-muted); }

        .cart-item button {
            background: rgba(255,255,255,0.1);
            border: none; color: white;
            width: 28px; height: 28px; border-radius: 6px;
            cursor: pointer; transition: 0.2s;
        }
        .cart-item button:hover { background: var(--primary); color: black; }

        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; color: var(--text-muted); align-items: center; }
        .total-row { 
            display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; 
            border-top: 2px dashed rgba(255,255,255,0.2); 
            font-size: 1.6rem; font-weight: 800; color: #fff; 
            text-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        /* --- BUTTONS & INPUTS --- */
        .btn-checkout {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: #fff; border: none; padding: 18px; border-radius: 12px;
            font-size: 1.2rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            transition: all 0.3s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-checkout:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6); filter: brightness(1.1); }
        .btn-checkout:active { transform: translateY(1px); }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%);
            color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; 
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            transition: 0.2s;
        }
        .btn-primary:hover { filter: brightness(1.2); }

        .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .btn-void { background: #475569; color: #e2e8f0; padding: 5px 10px; border:none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        input, select { 
            width: 100%; padding: 12px; 
            border: 1px solid var(--glass-border); 
            border-radius: 8px; 
            background: rgba(0,0,0,0.3); 
            color: white;
            font-family: inherit;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(56, 189, 248, 0.2); }
        
        /* Overriding browser defaults for date/number inputs */
        input[type="number"]::-webkit-inner-spin-button { opacity: 0.5; }

        /* Loyalty Grid in Cart */
        .customer-input-group { 
            background: rgba(0,0,0,0.2); 
            padding: 15px; border-radius: 12px; margin-bottom: 15px; 
            border: 1px solid var(--glass-border); 
        }
        .customer-input-group input { margin-bottom: 10px; background: rgba(0,0,0,0.4); }

        .loyalty-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .loyalty-box { padding: 10px; border-radius: 8px; text-align: center; font-size: 0.85rem; font-weight: bold; backdrop-filter: blur(5px); }
        .l-earn { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
        .l-spend { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }

        /* --- FORMS & TABLES (PANELS) --- */
        .panel-box { 
            background: var(--glass-bg); 
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            padding: 25px; border-radius: 16px; 
            box-shadow: var(--glass-shadow); margin-bottom: 25px; 
            color: #fff;
        }
        .panel-box h3 { margin-bottom: 15px; color: var(--primary); }

        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .full-width { grid-column: span 2; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; margin-top: 10px; }
        th { color: var(--text-muted); padding: 12px; text-align: left; font-size: 0.9rem; text-transform: uppercase; border-bottom: 1px solid var(--glass-border); }
        td { padding: 15px 12px; background: rgba(255,255,255,0.03); color: white; border: none; }
        tr td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        tr td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        tr:hover td { background: rgba(255,255,255,0.07); }
        tr.refunded td { text-decoration: line-through; color: #64748b; opacity: 0.6; }

        /* --- MODALS & OVERLAYS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); /* Darker dim */
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        
        /* Login Card */
        .login-card {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 50px; border-radius: 24px;
            width: 100%; max-width: 450px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        .login-card::before {
            content:''; position: absolute; top:0; left:0; right:0; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .login-input { 
            font-size: 2.5rem; text-align: center; letter-spacing: 15px; 
            margin: 30px 0; font-weight: bold; 
            background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.1);
            color: var(--primary);
            border-radius: 12px;
            transition: 0.3s;
        }
        .login-input:focus { border-color: var(--primary); box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
        
        .lockout-msg { color: var(--danger); font-weight: bold; margin-top: 10px; }
        .setup-warning { 
            background: rgba(251, 191, 36, 0.1); color: var(--warning); 
            padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left; border: 1px solid rgba(251, 191, 36, 0.3); 
        }

        /* --- RECEIPT PAPER EFFECT (VISUAL) --- */
        .receipt-card {
            background: #fff; /* Paper is white */
            width: 400px; max-height: 90vh; overflow-y: auto;
            padding: 0; display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border-radius: 4px;
            transform: rotate(-1deg); /* Slight organic tilt */
        }
        .receipt-visual {
            padding: 40px; font-family: 'Courier New', monospace; 
            background: #fff; color: #000; font-size: 1.1rem;
        }
        .receipt-actions {
            background: #f1f5f9; padding: 20px; border-top: 1px solid #cbd5e1;
            display: flex; gap: 10px;
        }
        .receipt-actions button { width: 100%; padding: 12px; border-radius: 6px; }

        .r-header { text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #000; padding-bottom: 15px; }
        .r-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1rem; }
        .r-total-block { border-top: 2px solid #000; margin-top: 20px; padding-top: 15px; font-weight: bold; text-align: right; }
        
        .z-table { width: 100%; margin-top: 15px; border-top: 1px solid #000; }
        .z-table td { background: transparent; color: black; border: none; padding: 5px 0; font-family: 'Courier New', monospace; }

        /* --- UTILS --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-deep); color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000;
        }
        
        .hidden { display: none !important; }
        .badge-role { 
            background: var(--primary); color: #000; padding: 4px 8px; border-radius: 4px; 
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px var(--primary-glow);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- PRINT OVERRIDES (Must remain stark white/black) --- */
        @media print {
            body * { visibility: hidden; }
            #receipt-modal, #receipt-modal *, .receipt-visual, .receipt-visual * {
                visibility: visible;
                color: black !important;
                background: white !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            #receipt-modal {
                position: absolute; left: 0; top: 0; width: 100%;
                background: white !important;
                backdrop-filter: none !important;
            }
            .receipt-card { transform: none; width: 100%; box-shadow: none; border: none; }
            .receipt-actions { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <h2 style="color:var(--primary); border:none; text-shadow: 0 0 20px var(--primary-glow); font-size: 3rem;">IRONCLAD POS</h2>
        <p style="color: var(--text-muted); margin-top: 10px;">Initializing Secure Crypto Engine...</p>
    </div>

    <div id="login-screen" class="overlay hidden">
        <div id="setup-view" class="login-card hidden">
            <div style="font-size: 4rem; margin-bottom: 10px;">‚öôÔ∏è</div>
            <h2 style="border:none; text-align:center;">System Setup</h2>
            <div class="setup-warning">
                <b>‚ö†Ô∏è MASTER KEY CREATION</b><br>
                Setting Admin PIN. This creates the primary encryption key for the vault.
            </div>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Create Admin PIN</p>
            <input type="password" id="pin-setup" class="login-input" maxlength="12" placeholder="PIN" autofocus>
            <button class="btn-checkout" onclick="app.setupSystem()">Initialize Vault</button>
        </div>

        <div id="login-view" class="login-card hidden">
            <div style="font-size: 4rem; margin-bottom: 20px;">üõ°Ô∏è</div>
            <h2 style="border:none; text-align:center;">Secure Vault</h2>
            <p style="color: var(--text-muted); margin-bottom: 10px;">Enter Admin or Cashier PIN</p>
            <input type="password" id="pin-input" class="login-input" maxlength="12" placeholder="******">
            <div id="lockout-timer" class="lockout-msg hidden"></div>
            <button id="btn-unlock" class="btn-checkout" onclick="app.attemptLogin()">Decrypt & Unlock</button>
        </div>
    </div>

    <div id="receipt-modal" class="overlay hidden">
        <div class="receipt-card">
            <div class="receipt-visual">
                <div class="r-header">
                    <h3>IRONCLAD POS</h3>
                    <p id="rm-status">Secure Transaction Record</p>
                    <p id="rm-date">Date: </p>
                    <p id="rm-id">TxID: </p>
                    <p id="rm-cust" style="font-weight:bold;">Customer: </p>
                    <p id="rm-pay" style="font-size:0.9rem; margin-top:5px;">Method: -</p>
                </div>
                <div id="rm-body"></div>
                <div class="r-total-block">
                    <div style="display:flex; justify-content:space-between;"><span>Subtotal:</span><span id="rm-sub"></span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Discount:</span><span id="rm-disc"></span></div>
                    <div style="display:flex; justify-content:space-between;"><span>VAT:</span><span id="rm-tax"></span></div>
                    <div style="display:flex; justify-content:space-between; font-size:1.2em; margin-top:5px;"><span>TOTAL:</span><span id="rm-tot"></span></div>
                    
                    <div style="margin-top:15px; border-top:1px dotted #000; padding-top:5px; font-size:0.85rem;">
                        <div style="display:flex; justify-content:space-between;"><span>Loyalty Earned:</span><span id="rm-pts">0</span></div>
                        <div style="display:flex; justify-content:space-between;"><span>Pay w/ Points Value:</span><span id="rm-pts-cost">0</span></div>
                    </div>
                </div>
            </div>
            <div class="receipt-actions">
                <button class="btn-checkout" style="background:#0f172a;" onclick="app.closeReceipt()">Close</button>
                <button class="btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>

    <!-- Z-REPORT MODAL -->
    <div id="z-report-modal" class="overlay hidden">
        <div class="receipt-card">
            <div class="receipt-visual">
                <div class="r-header">
                    <h3>END OF DAY (Z-REPORT)</h3>
                    <p id="z-date">Date: </p>
                </div>
                <div id="z-body"></div>
            </div>
            <div class="receipt-actions">
                <button class="btn-checkout" style="background:#0f172a;" onclick="document.getElementById('z-report-modal').classList.add('hidden')">Close</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand">üõ°Ô∏è IRONCLAD</div>
        <button class="nav-btn active" onclick="app.switchTab('sales')">üõí Sales Terminal</button>
        <button class="nav-btn" onclick="app.switchTab('history')">üïí History & Void</button>
        <button class="nav-btn admin-only" onclick="app.switchTab('inventory')">üì¶ Inventory</button>
        <button class="nav-btn admin-only" onclick="app.switchTab('looks')">üé® Management</button>
        <button class="nav-btn admin-only" onclick="app.switchTab('financials')">üìà Financials</button>
        
        <div style="margin-top:auto; font-size:0.75rem; opacity:0.7; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
            <p style="margin-bottom:5px;">Logged in as:</p> 
            <span id="user-role-badge" class="badge-role">...</span>
            <button class="btn-danger" style="margin-top:10px; width:100%" onclick="location.reload()">üîí Lock System</button>
        </div>
    </div>

    <div class="main-content">
        <div id="sales" class="tab-content active">
            <h2>Sales Terminal</h2>
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="product-search" 
                       placeholder="Scan Barcode or Search Item..." 
                       autocomplete="off" 
                       onkeyup="app.handleSearch(this)"
                       onkeydown="app.handleBarcodeEnter(event)">
            </div>

            <div class="sales-header" id="cat-filters"></div>
            <div class="sales-container">
                <div class="product-grid" id="pos-grid"></div>
                <div class="cart-panel glass-panel">
                    <h3>Current Order</h3>
                    
                    <!-- Customer Tagging & Loyalty Info -->
                    <div class="customer-input-group">
                        <input type="text" id="cust-contact" placeholder="Customer Phone / Email">
                        <div class="loyalty-grid">
                            <div class="loyalty-box l-earn">
                                <span style="display:block;font-size:0.7rem;opacity:0.8;">EARN</span>
                                +<span id="cart-points-earn">0</span>
                            </div>
                            <div class="loyalty-box l-spend">
                                <span style="display:block;font-size:0.7rem;opacity:0.8;">REDEEM COST</span>
                                <span id="cart-points-cost">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="cart-items" id="cart-items"></div>
                    <div class="summary-row"><span>Subtotal</span><span id="cart-sub">$0.00</span></div>
                    <div class="summary-row">
                        <span>Discount (%)</span>
                        <input type="number" id="cart-discount-input" value="0" min="0" max="100" style="width: 70px; padding: 5px; text-align: right;" onchange="app.renderCart()">
                    </div>
                    <div class="summary-row"><span>VAT (<span id="disp-tax-rate">0</span>%)</span><span id="cart-tax">$0.00</span></div>
                    <div class="summary-row" style="margin-top: 10px;">
                        <span>Method:</span>
                        <select id="cart-pay-method" style="width: 140px; padding: 5px;"></select>
                    </div>
                    <div class="total-row"><span>Total</span><span id="cart-total">$0.00</span></div>
                    <button class="btn-checkout" onclick="app.checkout()">Charge Customer</button>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <h2>Transaction History</h2>
            <p style="color:var(--text-muted); margin-bottom:15px;">View recent sales log and process voids.</p>
            <div class="panel-box">
                <table>
                    <thead><tr><th>ID</th><th>Customer</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="hist-table"></tbody>
                </table>
            </div>
        </div>

        <div id="inventory" class="tab-content">
            <h2>Inventory Management</h2>
            <div class="panel-box">
                <div class="form-grid">
                    <input type="text" id="inv-name" placeholder="Item Name" class="full-width">
                    <select id="inv-cat" class="full-width"><option value="">Select Category</option></select>
                    <input type="number" id="inv-price" placeholder="Sell Price" step="0.01">
                    <input type="number" id="inv-cost" placeholder="Unit Cost" step="0.01">
                    <input type="number" id="inv-stock" placeholder="Stock Qty">
                    <button class="btn-primary" onclick="app.addProduct()">Add Product</button>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table class="panel-box" style="display:table; width:100%;">
                    <thead><tr><th>Item</th><th>Category</th><th>Price</th><th>Stock</th><th>Action</th></tr></thead>
                    <tbody id="inv-table"></tbody>
                </table>
            </div>
        </div>

        <div id="looks" class="tab-content">
            <h2>Management Console</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="panel-box">
                        <h3>Staff Access</h3>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">Set a PIN for Cashier Mode (Sales Only).</p>
                        <div style="display:flex; gap:10px;">
                            <input type="password" id="new-cashier-pin" placeholder="New Cashier PIN" maxlength="12">
                            <button class="btn-primary" onclick="app.setCashierPin()">Set</button>
                        </div>
                    </div>
                    <div class="panel-box">
                        <h3>Categories</h3>
                        <div style="display:flex; gap:10px; margin-bottom:10px;"><input type="text" id="new-cat-name" placeholder="e.g., Drinks"><button class="btn-primary" onclick="app.addCategory()">Add</button></div>
                        <div id="cat-list"></div>
                    </div>
                </div>
                <div>
                    <div class="panel-box">
                        <h3>Payment Methods</h3>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="new-pay-method" placeholder="e.g., Bitcoin">
                            <button class="btn-primary" onclick="app.addPaymentMethod()">Add</button>
                        </div>
                        <div id="pay-method-list"></div>
                    </div>
                    <div class="panel-box">
                        <h3>Encrypted Backup</h3>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">Exports cleartext JSON.</p>
                        <button class="btn-primary" style="background:var(--warning); color:black; width:100%; border:none;" onclick="app.exportSystem()">Export Full Backup</button>
                        <hr style="margin:15px 0; border:0; border-top:1px solid rgba(255,255,255,0.1);">
                        <input type="file" onchange="app.importSystem(this)">
                    </div>
                    <div class="panel-box">
                        <h3>Tax & Loyalty</h3>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                            <span style="width:140px">Global VAT (%):</span>
                            <input type="number" id="setting-vat" style="width:100px;" onchange="app.saveSettings()">
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="width:140px">Loyalty Rate:</span>
                            <input type="number" id="setting-loyalty" style="width:100px;" placeholder="e.g. 10" onchange="app.saveSettings()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="financials" class="tab-content">
            <h2>Financial Overview</h2>
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="stats-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:20px; flex:1;">
                    <div class="panel-box" style="text-align:center; margin:0;"><div style="font-size:0.8rem; color:var(--text-muted);">Net Revenue</div><div style="font-size:1.8rem; font-weight:bold; color:white;" id="fin-rev">$0.00</div></div>
                    <div class="panel-box" style="text-align:center; margin:0;"><div style="font-size:0.8rem; color:var(--text-muted);">Net Profit</div><div style="font-size:1.8rem; font-weight:bold; color:var(--success); text-shadow:0 0 10px rgba(16,185,129,0.3);" id="fin-prof">$0.00</div></div>
                    <div class="panel-box" style="text-align:center; margin:0;"><div style="font-size:0.8rem; color:var(--text-muted);">Tax Collected</div><div style="font-size:1.8rem; font-weight:bold; color:white;" id="fin-tax">$0.00</div></div>
                </div>
                <button class="btn-primary" style="margin-left:20px; height: 100px; padding:0 30px; font-size:1.1rem;" onclick="app.generateZReport()">üìú End-of-Day<br>Z-Report</button>
            </div>
            <div class="panel-box">
                <h3>Financial Log</h3>
                <table><thead><tr><th>ID</th><th>Items</th><th>Total</th><th>Time</th></tr></thead><tbody id="fin-table"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        /** CRYPTO ENGINE (Key Wrapping V2) **/
        class CryptoManager {
            constructor() { 
                this.masterKey = null; // The actual key that encrypts data
                this.salt = null;
            }

            // Generate a random 256-bit Master Key
            async generateMasterKey() {
                return await window.crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
            }

            // Derive a Key-Encryption-Key (KEK) from a PIN
            async deriveKEK(pin, salt) {
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(pin), { name: "PBKDF2" }, false, ["deriveKey"]);
                return await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                    keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"] // false = KEK cannot be exported
                );
            }

            // Wrap the Master Key using the PIN-derived KEK
            async wrapKey(kek, masterKey) {
                const exportedKey = await window.crypto.subtle.exportKey("raw", masterKey);
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encryptedKey = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, kek, exportedKey);
                return { iv: Array.from(iv), data: Array.from(new Uint8Array(encryptedKey)) };
            }

            // Unwrap the Master Key
            async unwrapKey(kek, wrappedObject) {
                try {
                    const rawKey = await window.crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: new Uint8Array(wrappedObject.iv) }, 
                        kek, 
                        new Uint8Array(wrappedObject.data)
                    );
                    return await window.crypto.subtle.importKey("raw", rawKey, { name: "AES-GCM" }, true, ["encrypt", "decrypt"]);
                } catch(e) { return null; }
            }

            // Standard Data Encryption using Master Key
            async encrypt(d) { 
                if(!this.masterKey) throw "Locked";
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const c = await window.crypto.subtle.encrypt({name:'AES-GCM', iv}, this.masterKey, new TextEncoder().encode(JSON.stringify(d)));
                return {iv:Array.from(iv), d:Array.from(new Uint8Array(c))};
            }

            async decrypt(p) { 
                if(!this.masterKey) throw "Locked";
                try { return JSON.parse(new TextDecoder().decode(await window.crypto.subtle.decrypt({name:'AES-GCM', iv:new Uint8Array(p.iv)}, this.masterKey, new Uint8Array(p.d)))); } 
                catch(e){ return null; }
            }
        }

        /** DATABASE LAYER **/
        class DB {
            constructor() { this.db = null; }
            open() {
                return new Promise(r => {
                    const req = indexedDB.open('POS_SECURE_VAULT_V2', 1);
                    req.onupgradeneeded = e => {
                        const d = e.target.result;
                        ['products','transactions','categories'].forEach(s => { if(!d.objectStoreNames.contains(s)) d.createObjectStore(s, {keyPath:'id'}); });
                    };
                    req.onsuccess = e => { this.db = e.target.result; r(); };
                });
            }
            async op(s, m, d) { return new Promise(r => { const tx=this.db.transaction(s,'readwrite').objectStore(s)[m](d); tx.onsuccess=()=>r(tx.result); }); }
            async getAll(s) { return new Promise(r => { const req=this.db.transaction(s,'readonly').objectStore(s).getAll(); req.onsuccess=()=>r(req.result); }); }
        }

        /** APP LOGIC **/
        class App {
            constructor() {
    this.c = new CryptoManager(); 
    this.db = new DB();
    this.cart = []; this.products = []; this.cats = []; this.txs = [];
    this.vat = parseFloat(localStorage.getItem('pos_vat')||0);
    this.loyaltyRate = parseFloat(localStorage.getItem('pos_loyalty_rate')||0);
    this.activeCat = 'all';
    this.searchQuery = ""; // <--- ADD THIS
    this.role = null;
    this.payMethods = JSON.parse(localStorage.getItem('pos_pay_methods')) || ['Cash', 'Card'];
}

            async init() {
                // STORAGE PERSISTENCE API
                if (navigator.storage && navigator.storage.persist) {
                    navigator.storage.persist().then(granted => {
                        if (granted) console.log("Storage persistence granted.");
                        else console.log("Storage persistence denied.");
                    });
                }
// Add Ctrl+F Shortcut
window.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault(); // Stop browser search from opening
        this.switchTab('sales'); // Switch to sales tab
        const searchInput = document.getElementById('product-search');
        searchInput.focus();
        searchInput.select(); // Select existing text so you can just start typing
    }
});
                await this.db.open();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');

                const storedSalt = localStorage.getItem('pos_salt');
                
                if (!storedSalt) {
                    document.getElementById('setup-view').classList.remove('hidden');
                    document.getElementById('pin-setup').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.setupSystem(); });
                } else {
                    this.checkLockout();
                    document.getElementById('login-view').classList.remove('hidden');
                    document.getElementById('pin-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.attemptLogin(); });
                }
            }

            // XSS SANITIZATION
            sanitize(str) {
                if(!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            /* --- SECURITY & LOGIN LOGIC --- */

            async setupSystem() {
                const pin = document.getElementById('pin-setup').value;
                if(pin.length < 6) return alert("PIN must be at least 6 digits");
                if(!confirm("Warning: Losing this PIN means losing your data.")) return;

                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                this.c.salt = salt;

                // 1. Generate Master Key
                this.c.masterKey = await this.c.generateMasterKey();

                // 2. Derive Admin KEK and Wrap Master Key
                const adminKek = await this.c.deriveKEK(pin, salt);
                const wrappedKey = await this.c.wrapKey(adminKek, this.c.masterKey);

                localStorage.setItem('pos_salt', JSON.stringify(Array.from(salt)));
                localStorage.setItem('pos_wrapped_admin', JSON.stringify(wrappedKey));

                this.role = 'admin';
                this.enterApp();
            }

            async attemptLogin() {
                if(this.isLockedOut()) return;

                const pin = document.getElementById('pin-input').value;
                const salt = new Uint8Array(JSON.parse(localStorage.getItem('pos_salt')));
                
                // Try to Unlock as Admin
                const inputKek = await this.c.deriveKEK(pin, salt);
                const adminWrapped = JSON.parse(localStorage.getItem('pos_wrapped_admin'));
                
                let masterKey = await this.c.unwrapKey(inputKek, adminWrapped);
                
                if(masterKey) {
                    this.role = 'admin';
                    this.c.masterKey = masterKey;
                    localStorage.setItem('pos_fails', 0);
                    return this.enterApp();
                }

                // If not admin, try Cashier
                const cashierWrapped = JSON.parse(localStorage.getItem('pos_wrapped_cashier'));
                if(cashierWrapped) {
                    masterKey = await this.c.unwrapKey(inputKek, cashierWrapped);
                    if(masterKey) {
                        this.role = 'cashier';
                        this.c.masterKey = masterKey;
                        localStorage.setItem('pos_fails', 0);
                        return this.enterApp();
                    }
                }

                this.handleFail();
            }

            async setCashierPin() {
                const pin = document.getElementById('new-cashier-pin').value;
                if(!pin || pin.length < 4) return alert("PIN too short");
                
                // Wrap current MasterKey with new Cashier PIN
                const salt = new Uint8Array(JSON.parse(localStorage.getItem('pos_salt')));
                const cashierKek = await this.c.deriveKEK(pin, salt);
                const wrapped = await this.c.wrapKey(cashierKek, this.c.masterKey);
                
                localStorage.setItem('pos_wrapped_cashier', JSON.stringify(wrapped));
                alert("Cashier PIN Set Successfully");
                document.getElementById('new-cashier-pin').value = '';
            }

            handleFail() {
                let fails = parseInt(localStorage.getItem('pos_fails') || 0) + 1;
                localStorage.setItem('pos_fails', fails);
                document.getElementById('pin-input').value = '';
                
                if (fails >= 3) {
                    localStorage.setItem('pos_lockout', Date.now() + 30000); // 30s lockout
                    this.checkLockout();
                } else {
                    alert(`Incorrect PIN. Attempt ${fails}`);
                }
            }

            isLockedOut() { return Date.now() < parseInt(localStorage.getItem('pos_lockout') || 0); }

            checkLockout() {
                const lockUntil = parseInt(localStorage.getItem('pos_lockout') || 0);
                const now = Date.now();
                const timerEl = document.getElementById('lockout-timer');
                const btn = document.getElementById('btn-unlock');

                if (now < lockUntil) {
                    timerEl.innerText = `System Locked: ${Math.ceil((lockUntil - now) / 1000)}s`;
                    timerEl.classList.remove('hidden');
                    btn.disabled = true;
                    setTimeout(() => this.checkLockout(), 1000);
                } else {
                    timerEl.classList.add('hidden');
                    btn.disabled = false;
                }
            }

            async enterApp() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('user-role-badge').innerText = this.role.toUpperCase();
                
                // UI Restriction
                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(el => el.style.display = this.role === 'admin' ? 'flex' : 'none');

                await this.load();
                document.getElementById('setting-vat').value = this.vat;
                document.getElementById('setting-loyalty').value = this.loyaltyRate;
                this.renderAll();
            }
            // Updates the grid as you type
handleSearch(el) {
    this.searchQuery = el.value.toLowerCase().trim();
    this.renderGrid();
}

// specialized handler for Barcode Scanners (which usually send 'Enter' after code)
handleBarcodeEnter(e) {
    if (e.key === 'Enter') {
        const visibleItems = this.getFilteredProducts();
        
        // If exact match or only one result, add to cart automatically
        if (visibleItems.length === 1) {
            this.addToCart(visibleItems[0].id);
            this.searchQuery = ""; // Clear search
            document.getElementById('product-search').value = ""; // Clear input
            this.renderGrid(); // Reset grid
        }
    }
}

// Helper to centralize filter logic
getFilteredProducts() {
    let filtered = this.products;

    // 1. Filter by Category
    if (this.activeCat !== 'all') {
        filtered = filtered.filter(p => p.catId == this.activeCat);
    }

    // 2. Filter by Search (Name or ID/Barcode)
    if (this.searchQuery) {
        filtered = filtered.filter(p => 
            p.name.toLowerCase().includes(this.searchQuery) || 
            p.id.toString().includes(this.searchQuery)
        );
    }
    return filtered;
}

            /* --- CORE APP --- */

            async load() {
                const dec = async (arr) => {
                    const res = [];
                    for(let i of arr) {
                        const d = await this.c.decrypt(i.blob);
                        if(d) res.push({...d, id:i.id});
                    }
                    return res;
                };
                
                this.products = await dec(await this.db.getAll('products'));
                this.cats = await dec(await this.db.getAll('categories'));
                this.txs = await dec(await this.db.getAll('transactions'));
                this.txs.sort((a,b)=>b.date-a.date);
            }

            renderAll() {
                this.renderCats(); this.renderGrid(); this.renderInv(); this.renderFin(); this.renderHistory(); this.renderPayMethods();
                document.getElementById('disp-tax-rate').innerText = this.vat;
            }

            renderCats() {
                const html = `<div class="cat-pill ${this.activeCat==='all'?'active':''}" onclick="app.setCat('all')">All Items</div>` +
                    this.cats.map(c => `<div class="cat-pill ${this.activeCat===c.id?'active':''}" onclick="app.setCat(${c.id})">${this.sanitize(c.name)}</div>`).join('');
                document.getElementById('cat-filters').innerHTML = html;
                document.getElementById('cat-list').innerHTML = this.cats.map(c => 
                    `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1);"><span>${this.sanitize(c.name)}</span><button class="btn-danger" onclick="app.delCat(${c.id})">√ó</button></div>`
                ).join('');
                document.getElementById('inv-cat').innerHTML = '<option value="">Uncategorized</option>' + this.cats.map(c => `<option value="${c.id}">${this.sanitize(c.name)}</option>`).join('');
            }

            setCat(id) { this.activeCat = id; this.renderGrid(); this.renderCats(); }

           renderGrid() {
    const grid = document.getElementById('pos-grid');
    const filtered = this.getFilteredProducts(); // Use the new helper
    
    if (filtered.length === 0) {
        grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 20px; color: var(--text-muted);">No items found.</div>`;
        return;
    }

    grid.innerHTML = filtered.map(p => `
        <div class="product-card ${p.stock<1?'out-of-stock':''}" onclick="app.addToCart(${p.id})">
            <div><div class="p-name">${this.sanitize(p.name)}</div><div class="p-cat">${this.sanitize(this.cats.find(c=>c.id == p.catId)?.name || '')}</div></div>
            <div><div class="p-price">$${p.price.toFixed(2)}</div><div class="p-stock">Stock: ${p.stock}</div></div>
        </div>`).join('');
}

            addToCart(id) {
                const p = this.products.find(x=>x.id===id);
                if(!p || p.stock<=0) return;
                const i = this.cart.find(x=>x.id===id);
                if(i) { if(i.qty < p.stock) i.qty++; } else this.cart.push({...p, qty:1});
                this.renderCart();
            }

            renderCart() {
                const con = document.getElementById('cart-items');
                let sub = 0;
                con.innerHTML = this.cart.map(i => {
                    sub += i.price * i.qty;
                    return `<div class="cart-item">
                        <div><b>${this.sanitize(i.name)}</b><br><small>$${i.price} x ${i.qty}</small></div>
                        <div><button onclick="app.mod(${i.id},-1)">-</button> <span style="color:white; margin:0 5px;">${i.qty}</span> <button onclick="app.mod(${i.id},1)">+</button></div>
                    </div>`;
                }).join('');

                const discPct = parseFloat(document.getElementById('cart-discount-input').value) || 0;
                const discAmt = sub * (discPct/100);
                const afterDisc = sub - discAmt;
                const tax = afterDisc * (this.vat/100);
                const total = afterDisc + tax;

                // Loyalty Calculation
                // 1. Earning: Based on Post-Discount, Pre-Tax amount
                const pointsEarned = Math.floor(afterDisc * this.loyaltyRate);
                
                // 2. Redemption Cost: Based on Total (Inc Tax) / 0.01
                // 1 Point = $0.01 (Redemption Rate)
                const pointsNeeded = Math.ceil(total / 0.01);

                document.getElementById('cart-sub').innerText = `$${sub.toFixed(2)}`;
                document.getElementById('cart-tax').innerText = `$${tax.toFixed(2)}`;
                document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;
                
                // Loyalty Display
                document.getElementById('cart-points-earn').innerText = `${pointsEarned}`;
                document.getElementById('cart-points-cost').innerText = `${pointsNeeded} pts`;
            }

            mod(id, d) {
                const i = this.cart.find(x=>x.id===id);
                const p = this.products.find(x=>x.id===id);
                const n = i.qty + d;
                if(n<=0) this.cart = this.cart.filter(x=>x.id!==id);
                else if(n<=p.stock) i.qty = n;
                this.renderCart();
            }

            renderPayMethods() {
                // Cart Selection
                const cartSel = document.getElementById('cart-pay-method');
                cartSel.innerHTML = this.payMethods.map(m => `<option value="${m}">${this.sanitize(m)}</option>`).join('');
                
                // Admin List
                const adminList = document.getElementById('pay-method-list');
                adminList.innerHTML = this.payMethods.map(m => 
                    `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1);"><span>${this.sanitize(m)}</span><button class="btn-danger" onclick="app.delPaymentMethod('${m}')">√ó</button></div>`
                ).join('');
            }

            addPaymentMethod() {
                const val = document.getElementById('new-pay-method').value.trim();
                if(val && !this.payMethods.includes(val)) {
                    this.payMethods.push(val);
                    localStorage.setItem('pos_pay_methods', JSON.stringify(this.payMethods));
                    this.renderPayMethods();
                    document.getElementById('new-pay-method').value = '';
                }
            }

            delPaymentMethod(name) {
                if(!confirm(`Delete method ${name}?`)) return;
                this.payMethods = this.payMethods.filter(m => m !== name);
                localStorage.setItem('pos_pay_methods', JSON.stringify(this.payMethods));
                this.renderPayMethods();
            }

            async checkout() {
                if(!this.cart.length) return alert("Empty Cart");
                
                let sub=0, cost=0;
                this.cart.forEach(i => { sub += i.price*i.qty; cost += i.cost*i.qty; });
                const discPct = parseFloat(document.getElementById('cart-discount-input').value) || 0;
                const discAmt = sub * (discPct/100);
                const afterDisc = sub - discAmt;
                const tax = afterDisc * (this.vat/100);
                const total = afterDisc + tax;
                const payMethod = document.getElementById('cart-pay-method').value || 'Cash';
                
                const cust = document.getElementById('cust-contact').value.trim();
                
                // Loyalty Snapshot
                const pointsEarned = Math.floor(afterDisc * this.loyaltyRate);
                const pointsCost = Math.ceil(total / 0.01);

                // Inventory Deduction
                for(let i of this.cart) {
                    const p = this.products.find(x=>x.id===i.id);
                    p.stock -= i.qty;
                    await this.db.op('products', 'put', {id:p.id, blob:await this.c.encrypt(p)});
                }

                const tx = {
                    id: Date.now(), date: Date.now(), 
                    items: this.cart.map(x=>({id:x.id, n:x.name, q:x.qty, p:x.price})),
                    sub, disc: discAmt, tax, total, profit: (sub-discAmt)-cost,
                    method: payMethod,
                    customer: cust,
                    points: pointsEarned,
                    pointsCost: pointsCost, // Store how much it would cost in points for reference
                    refunded: false
                };
                
                await this.db.op('transactions', 'add', {id:tx.id, blob:await this.c.encrypt(tx)});
                this.showReceiptModal(tx);
            }

            showReceiptModal(tx) {
                document.getElementById('rm-status').innerText = tx.refunded ? "VOID / REFUNDED" : "Secure Transaction Record";
                document.getElementById('rm-status').style.color = tx.refunded ? "red" : "black";
                document.getElementById('rm-date').innerText = `Date: ${new Date(tx.date).toLocaleString()}`;
                document.getElementById('rm-id').innerText = `TxID: #${tx.id.toString().slice(-6)}`;
                document.getElementById('rm-cust').innerText = `Customer: ${this.sanitize(tx.customer || 'Guest')}`;
                document.getElementById('rm-pay').innerText = `Method: ${this.sanitize(tx.method || 'Cash')}`;
                document.getElementById('rm-body').innerHTML = tx.items.map(i => 
                    `<div class="r-item"><span>${i.q}x ${this.sanitize(i.n)}</span><span>${(i.p*i.q).toFixed(2)}</span></div>`
                ).join('');
                document.getElementById('rm-sub').innerText = tx.sub.toFixed(2);
                document.getElementById('rm-disc').innerText = `-${tx.disc.toFixed(2)}`;
                document.getElementById('rm-tax').innerText = tx.tax.toFixed(2);
                document.getElementById('rm-tot').innerText = `$${tx.total.toFixed(2)}`;
                
                document.getElementById('rm-pts').innerText = `${tx.points || 0} pts`;
                document.getElementById('rm-pts-cost').innerText = `${tx.pointsCost || 0} pts`;
                
                document.getElementById('receipt-modal').classList.remove('hidden');
            }

            async closeReceipt() {
                this.cart = []; 
                document.getElementById('cart-discount-input').value = 0;
                document.getElementById('cust-contact').value = '';
                document.getElementById('receipt-modal').classList.add('hidden');
                await this.load(); 
                this.renderAll(); 
            }

            /* --- HISTORY & REFUNDS --- */
            renderHistory() {
                document.getElementById('hist-table').innerHTML = this.txs.slice(0, 50).map(x => `
                    <tr class="${x.refunded ? 'refunded' : ''}">
                        <td>#${x.id.toString().slice(-4)}</td>
                        <td>${this.sanitize(x.customer || 'Guest')}</td>
                        <td>$${x.total.toFixed(2)}</td>
                        <td style="font-weight:bold; color:${x.refunded?'#ef4444':'#34d399'}">${x.refunded ? 'VOID' : 'OK'}</td>
                        <td>
                            <button class="btn-primary" style="padding:4px 8px; font-size:0.8rem;" onclick='app.showReceiptModal(${JSON.stringify(x).replace(/'/g, "&apos;")})'>View</button>
                            ${!x.refunded ? `<button class="btn-void" onclick="app.refundTx(${x.id})">Void</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            }

            async refundTx(id) {
                if(!confirm("VOID Transaction? This will restore stock and balance financials.")) return;
                
                const tx = this.txs.find(x => x.id === id);
                if(!tx || tx.refunded) return;

                // 1. Mark Original as Refunded
                tx.refunded = true;
                await this.db.op('transactions', 'put', {id:tx.id, blob:await this.c.encrypt(tx)});

                // 2. Restore Stock
                for(let item of tx.items) {
                    const p = this.products.find(x => x.id === item.id);
                    if(p) {
                        p.stock += item.q;
                        await this.db.op('products', 'put', {id:p.id, blob:await this.c.encrypt(p)});
                    }
                }

                // 3. Create Negative Transaction for Balancing
                const refTx = {
                    id: Date.now(),
                    date: Date.now(),
                    items: tx.items.map(i=>({...i, n: `[REFUND] ${i.n}`, q: -i.q})),
                    sub: -tx.sub, disc: -tx.disc, tax: -tx.tax, total: -tx.total, profit: -tx.profit,
                    method: tx.method,
                    customer: tx.customer,
                    points: -(tx.points || 0), // Deduct Points on refund
                    refunded: true 
                };
                await this.db.op('transactions', 'add', {id:refTx.id, blob:await this.c.encrypt(refTx)});

                await this.load();
                this.renderAll();
                alert("Transaction Voided & Stock Restored");
            }

            /* --- ADMIN MANAGEMENT --- */
            async addCategory() {
                const n = document.getElementById('new-cat-name').value;
                if(!n) return;
                const c = {id:Date.now(), name:n};
                await this.db.op('categories', 'add', {id:c.id, blob:await this.c.encrypt(c)});
                document.getElementById('new-cat-name').value='';
                await this.load(); this.renderAll();
            }

            async delCat(id) {
                if(!confirm('Delete Category?')) return;
                await this.db.op('categories', 'delete', id);
                await this.load(); this.renderAll();
            }

            async addProduct() {
                const name = document.getElementById('inv-name').value;
                const catId = document.getElementById('inv-cat').value;
                const price = parseFloat(document.getElementById('inv-price').value);
                const cost = parseFloat(document.getElementById('inv-cost').value);
                const stock = parseInt(document.getElementById('inv-stock').value);
                if(!name || isNaN(price)) return;
                const p = { id:Date.now(), name, catId: catId?parseInt(catId):null, price, cost, stock };
                await this.db.op('products', 'add', {id:p.id, blob:await this.c.encrypt(p)});
                document.querySelectorAll('#inventory input').forEach(i=>i.value='');
                await this.load(); this.renderAll();
            }

            renderInv() {
                document.getElementById('inv-table').innerHTML = this.products.map(p => `
                    <tr><td>${this.sanitize(p.name)}</td><td>${this.sanitize(this.cats.find(c=>c.id==p.catId)?.name||'-')}</td>
                    <td>${p.price}</td><td>${p.stock}</td>
                    <td><button class="btn-danger" onclick="app.delProd(${p.id})">Del</button></td></tr>`
                ).join('');
            }
            async delProd(id) { if(confirm('Delete?')) { await this.db.op('products','delete',id); await this.load(); this.renderAll(); } }

            saveSettings() {
                this.vat = parseFloat(document.getElementById('setting-vat').value);
                this.loyaltyRate = parseFloat(document.getElementById('setting-loyalty').value);
                localStorage.setItem('pos_vat', this.vat);
                localStorage.setItem('pos_loyalty_rate', this.loyaltyRate);
                this.renderAll();
            }

            renderFin() {
                let r=0, p=0, t=0;
                this.txs.forEach(x => { 
                    r += x.total; 
                    p += x.profit; 
                    t += x.tax; 
                });
                document.getElementById('fin-rev').innerText = `$${r.toFixed(2)}`;
                document.getElementById('fin-prof').innerText = `$${p.toFixed(2)}`;
                document.getElementById('fin-tax').innerText = `$${t.toFixed(2)}`;
                document.getElementById('fin-table').innerHTML = this.txs.slice(0,20).map(x=>
                    `<tr><td>#${x.id.toString().slice(-4)}</td>
                    <td style="font-size:0.8rem">${x.items.length} items</td>
                    <td style="color:${x.total<0?'#ef4444':'white'}">$${x.total.toFixed(2)}</td><td>${new Date(x.date).toLocaleTimeString()}</td></tr>`
                ).join('');
            }

            // Z-REPORT GENERATION
            generateZReport() {
                const todayStart = new Date();
                todayStart.setHours(0,0,0,0);
                
                const todayTxs = this.txs.filter(t => t.date >= todayStart.getTime());
                
                let totalSales = 0;
                let totalTax = 0;
                let refundTotal = 0;
                let methodBreakdown = {};

                todayTxs.forEach(t => {
                    // Skip negative balancing transactions from stats to avoid double counting if needed,
                    // but for Z-report we want net.
                    // Actually, if we include negative transactions, the sum is correct net.
                    totalSales += t.total;
                    totalTax += t.tax;
                    
                    if(t.refunded) {
                        // Original transaction marked as refunded. 
                        // Do nothing here, as we likely have a negative counterpart transaction that balances it.
                        // However, purely for display:
                    }

                    // For Payment breakdown, we want to sum by method.
                    // Even negative refunds should have a method attached to reduce that method's total.
                    const method = t.method || 'Cash';
                    if(!methodBreakdown[method]) methodBreakdown[method] = 0;
                    methodBreakdown[method] += t.total;
                });

                const dateStr = todayStart.toLocaleDateString();
                document.getElementById('z-date').innerText = `Date: ${dateStr}`;
                
                let breakdownHtml = Object.keys(methodBreakdown).map(k => 
                    `<tr><td>${this.sanitize(k)}:</td><td style="text-align:right">$${methodBreakdown[k].toFixed(2)}</td></tr>`
                ).join('');

                const body = `
                    <table class="z-table">
                        <tr><td>Tx Count:</td><td style="text-align:right">${todayTxs.length}</td></tr>
                        <tr><td>Tax Collected:</td><td style="text-align:right">$${totalTax.toFixed(2)}</td></tr>
                        <tr style="font-weight:bold; font-size:1.1em; border-top:1px dashed #000;">
                            <td>NET SALES:</td><td style="text-align:right">$${totalSales.toFixed(2)}</td>
                        </tr>
                    </table>
                    <div style="margin-top:15px; font-weight:bold; border-bottom:1px solid #000;">By Payment Method:</div>
                    <table class="z-table">${breakdownHtml}</table>
                `;
                
                document.getElementById('z-body').innerHTML = body;
                document.getElementById('z-report-modal').classList.remove('hidden');
            }

            async exportSystem() {
                if(!confirm("Export Backup?")) return;
                const data = { vat: this.vat, loyalty: this.loyaltyRate, p: this.products, c: this.cats, t: this.txs };
                const b = new Blob([JSON.stringify(data)],{type:'application/json'});
                const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='pos_backup.json'; a.click();
            }

            async importSystem(inp) {
                if(!inp.files[0] || !confirm("OVERWRITE DATA?")) return;
                const r = new FileReader();
                r.onload = async e => {
                    try {
                        const d = JSON.parse(e.target.result);
                        localStorage.setItem('pos_vat', d.vat);
                        localStorage.setItem('pos_loyalty_rate', d.loyalty || 0);
                        const store = async (n, arr) => {
                            const tx = this.db.db.transaction(n,'readwrite').objectStore(n);
                            tx.clear(); 
                            for(let i of arr) {
                                const blob = await this.c.encrypt(i);
                                tx.put({id:i.id, blob:blob});
                            }
                            return new Promise(res => tx.transaction.oncomplete=res);
                        };
                        await store('products', d.p); await store('categories', d.c); await store('transactions', d.t);
                        location.reload();
                    } catch(err) { alert("Import Failed"); }
                };
                r.readAsText(inp.files[0]);
            }

          switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // Find the button that was clicked (approximate fix for the event.currentTarget issue in original code)
    const btn = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.onclick.toString().includes(`'${id}'`));
    if(btn) btn.classList.add('active');

    // FOCUS SEARCH BAR if Sales tab
    if(id === 'sales') {
        setTimeout(() => document.getElementById('product-search').focus(), 100);
    }
}
}

        const app = new App();
        window.onload = () => app.init();
    </script>
</body>
</html>
